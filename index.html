<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>CPBL 2025 çµ‚æ¥µç¶“ç†äººï¼šç„¡é™æ‡‰æ´ç‰ˆ (V5)</title>
    <style>
        :root { 
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --primary: #1565c0; --accent: #ff4081; --gold: #ffd700; 
            --my-team-color: #90caf9; /* è—è‰² */
            --opp-team-color: #ffcc80; /* æ©˜è‰² */
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* ç¨€æœ‰åº¦ */
        .r-SSR { color: var(--gold); text-shadow: 0 0 8px rgba(255, 215, 0, 0.6); font-weight: bold; }
        .r-SR { color: #e0e0e0; text-shadow: 0 0 5px rgba(255, 255, 255, 0.4); font-weight: bold; }
        .r-R { color: #42a5f5; font-weight: bold; }
        .r-N { color: #9e9e9e; }
        .r-Special { color: #ff5252; text-shadow: 0 0 8px rgba(255, 82, 82, 0.6); font-weight: bold; } /* æ¼”å”±æœƒå˜‰è³“ */
        .injured { color: #ff5252; text-decoration: line-through; opacity: 0.7; }
        
        /* å•¦å•¦éšŠ Buff ç­‰ç´šé¡è‰² */
        .cheer-buff-lv1 { color: var(--accent); }
        .cheer-buff-lv2 { color: #ff80ab; font-weight: bold; }
        .cheer-buff-lv3 { color: #c3f0ff; font-weight: bold; text-shadow: 0 0 5px #ffb3f0; }
        .cheer-buff-lv4 { color: var(--gold); font-weight: bold; text-shadow: 0 0 8px var(--gold); }


        /* å¸ƒå±€ */
        .screen { display: none; height: 100%; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .screen.active { display: block; }
        
        /* é¸éšŠ */
        #screen-select { text-align: center; background: radial-gradient(circle, #1a237e 0%, #000 90%); }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; max-width: 1000px; margin: 40px auto; }
        .team-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; cursor: pointer; border: 1px solid #444; transition: 0.3s; }
        .team-card:hover { border-color: var(--gold); transform: translateY(-5px); background: rgba(255,255,255,0.15); }
        .team-logo { font-size: 3rem; display: block; margin-bottom: 5px; }

        /* Header */
        header { height: 55px; background: #0d47a1; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 3px solid var(--gold); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .nav-btn { background: transparent; border: none; color: #bbb; font-weight: bold; cursor: pointer; padding: 0 15px; height: 100%; font-size: 1rem; }
        .nav-btn.active { color: #fff; border-bottom: 4px solid #fff; background: rgba(255,255,255,0.1); }
        .money-badge { background: linear-gradient(45deg, #ffb300, #f57f17); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: bold; }

        /* é¢æ¿ */
        .panel { background: var(--card); border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 5px; color: var(--my-team-color); font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 6px; text-align: left; border-bottom: 1px solid #333; }
        select { width: 100%; background: #2c2c2c; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 4px; }
        option:disabled { color: #ff5252; background: #222; }

        /* é«”åŠ›æ¢ */
        .sta-bar-bg { width: 50px; height: 6px; background: #444; display: inline-block; border-radius: 3px; }
        .sta-bar-fill { height: 100%; border-radius: 3px; }

        /* å•¦å•¦éšŠæ¸…å–® */
        .cheer-item { background: #333; padding: 5px 8px; border-radius: 4px; font-size: 0.8rem; border-left: 3px solid var(--accent); }

        /* æ¯”è³½å€ */
        .game-layout { display: grid; grid-template-columns: 260px 1fr 260px; gap: 15px; height: calc(100vh - 120px); }
        @media(max-width: 900px) { .game-layout { grid-template-columns: 1fr; } }
        
        #play-log { height: 220px; overflow-y: auto; background: #111; padding: 10px; font-family: monospace; font-size: 0.9rem; line-height: 1.5; border: 1px solid #444; }
        .log-hl { color: var(--gold); } .log-out { color: #90a4ae; } .log-score { color: #69f0ae; font-weight: bold; }
        .log-inj { color: #ff5252; font-weight: bold; background: rgba(255,0,0,0.1); padding: 2px; }
        .log-error { color: #ffa000; font-weight: bold; }

        /* éšŠä¼é¡è‰² */
        .my-team-color { color: var(--my-team-color); }
        .opp-team-color { color: var(--opp-team-color); }

        /* å£˜åŒ…å‹•æ…‹ */
        .base { transition: background 0.2s, box-shadow 0.2s; }
        .base.active { background: #ff4081 !important; border-color: #f06292 !important; box-shadow: 0 0 10px #ff4081; }

        /* å ´åœ°è³‡è¨Š */
        #weather-info { background: #333; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem; }
        .wind { color: #81c784; } .weather { color: #fff176; }
        
        /* é™£å®¹æŒ‰éˆ•ç¾¤çµ„ */
        .lineup-btns { display: flex; gap: 8px; }
        .lineup-btns button { font-size:0.8rem; padding: 5px 10px; }
        .btn-clear { background: #e57373; color: white; border: none; }
        .btn-optimize { background: #4caf50; color: white; border: none; }
        .btn-fuse { background: #03a9f4; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-fuse:disabled { background: #555; cursor: not-allowed; }

        /* æ‹›å‹Ÿå€å¡Š */
        .gacha-buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .btn-gacha { padding: 10px 20px; font-size: 1.1rem; font-weight: bold; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
        .btn-single { background: #03a9f4; color: white; border: none; }
        .btn-ten { background: var(--gold); color: #000; border: 2px solid #fff; } 

        .gacha-box { 
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; 
            max-height: 250px; overflow-y: auto; padding: 10px; 
        }
        .gacha-card { 
            width: 80px; text-align: center; padding: 5px; border-radius: 4px; 
            background: #2e7d32; /* Default */
            border: 1px solid #4caf50;
            font-size: 0.8rem;
        }
        .SSR { background: #ffd700; color: #111; border-color: #fff; }
        .SR { background: #e0e0e0; color: #111; border-color: #9e9e9e; }
        .R { background: #42a5f5; color: white; border-color: #1565c0; }
        .N { background: #9e9e9e; color: #111; border-color: #757575; }
        .Cheer { background: var(--accent); color: white; border-color: #f8bbd0; }
        
        .fusion-item {
            background: #222;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

<div id="screen-select" class="screen active">
    <h1 style="color: white; margin-top: 50px;">CPBL 2025 çµ‚æ¥µç¶“ç†äºº (V5)</h1>
    <p style="color: #aaa;">è«‹é¸æ“‡çƒéšŠ (åŒ…å«åˆå§‹çƒå“¡ã€è³‡é‡‘ $1,000,000 èˆ‡å°ˆå±¬å•¦å•¦éšŠ)</p>
    <div class="team-grid" id="team-list"></div>
</div>

<div id="screen-main" class="screen">
    <header>
        <div style="font-weight: bold;">âš¾ ç„¡é™æ‡‰æ´ç‰ˆ (V5)</div>
        <nav style="height: 100%;">
            <button class="nav-btn active" onclick="setTab('roster')">é™£å®¹ç®¡ç†</button>
            <button class="nav-btn" onclick="setTab('game')">æ¯”è³½è½‰æ’­</button>
            <button class="nav-btn" onclick="setTab('scout')">çƒå“¡æ‹›å‹Ÿ</button>
        </nav>
        <div class="money-badge" id="money-val">$1,000,000</div>
    </header>

    <div id="tab-roster" style="margin-top: 15px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 300px; gap: 15px;">
            <div class="panel">
                <h3>
                    ğŸ“‹ å…ˆç™¼æ‰“ç·š 
                    <span style="font-size:0.8rem; color:var(--gold);"> (SSR é™åˆ¶: 2 å¼µ)</span>
                    <span class="lineup-btns">
                        <button class="btn-optimize" onclick="autoLineup()">ä¸€éµæœ€ä½³åŒ–</button>
                        <button class="btn-clear" onclick="clearAllLineup()">ä¸€éµæ¸…ç©ºæ‰€æœ‰é™£å®¹</button>
                    </span>
                </h3>
                <table id="lineup-table">
                    <thead><tr><th>æ£’æ¬¡</th><th>çƒå“¡é¸æ“‡ (æ•¸å€¼/é«”åŠ›/æ…£ç”¨æ‰‹)</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="panel">
                <h3>âš¾ æŠ•æ‰‹è¼ªå€¼ </h3>
                <table id="rotation-table">
                    <thead><tr><th>è§’è‰²</th><th>çƒå“¡é¸æ“‡ (æ•¸å€¼/é«”åŠ›/æ…£ç”¨æ‰‹)</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="panel" style="border-color: var(--accent);">
                <h3>ğŸ“£ æ‡‰æ´åœ˜ (Buff)</h3>
                <p style="font-size:0.8rem; color:#aaa;">æå‡å£«æ°£ï¼Œæ¸›å°‘å—å‚·ç‡</p>
                <div id="cheer-slots"></div>
            </div>

            <div class="panel" style="grid-column: span 3;">
                <h3>ğŸ“£ æ‰€æœ‰å•¦å•¦éšŠæ¸…å–® (å…± <span id="cheer-count">0</span> äºº)</h3>
                <div id="cheer-roster-view" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 120px; overflow-y: auto;"></div>
            </div>
            
            <div class="panel" style="grid-column: span 3;">
                <h3>ğŸ¥ çƒå“¡ç‹€æ…‹ç›£æ§ (ç¸½æ•¸: <span id="roster-count">0</span>)</h3>
                <p style="font-size:0.8rem; color:#aaa;">* é«”åŠ›éä½ (&lt;30) å®¹æ˜“å—å‚·ï¼Œå—å‚·éœ€ä¼‘é¤Š 3-5 å ´ã€‚ä½é«”åŠ›å®ˆå‚™å“¡æ˜“å¤±èª¤ã€‚</p>
                <div id="roster-view" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 160px; overflow-y: auto;"></div>
            </div>
        </div>
        
        <div class="panel" style="margin-top: 15px;">
            <h3>ğŸ”® åˆæˆé€²åŒ–ä¸­å¿ƒ (10 å¼µå¡ç‰‡åˆæˆ <span style="color:#69f0ae;">+1%</span> èƒ½åŠ›)</h3>
            <div id="fusion-center">
                <p style="color:#aaa; font-style:italic;">ç›®å‰æ²’æœ‰è¶³å¤ çš„é‡è¤‡çƒå“¡æˆ–å•¦å•¦éšŠå¯ä»¥åˆæˆã€‚</p>
            </div>
        </div>

    </div>

    <div id="tab-game" style="display: none; margin-top: 15px;">
        <div class="game-layout">
            <div class="panel">
                <h3>ğŸ†š å°æ‰‹ (<span id="opp-name">---</span>)</h3>
                <div style="margin-bottom:10px; padding:8px; background:#263238; border-left:3px solid #ef5350;">
                    <div style="font-size:0.8rem; color:#aaa;">å…ˆç™¼æŠ•æ‰‹</div>
                    <div id="opp-sp" style="font-weight:bold;">---</div>
                </div>
                <div style="font-size:0.85rem; color:#bbb;">å…ˆç™¼æ‰“ç·šï¼š</div>
                <ul id="opp-lineup-list" style="padding-left:20px; font-size:0.8rem; color:#aaa;"></ul>
            </div>

            <div class="panel">
                <div id="weather-info"></div>

                <div style="display: grid; grid-template-columns: 1fr 80px 1fr; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; background: #000;">
                    <div style="font-size: 2.5rem; font-weight: bold; text-align: center; color:var(--opp-team-color)" id="score-a">0</div>
                    <div style="text-align:center;">
                        <div id="inning-txt" style="color:var(--gold); font-weight:bold; font-size:1.2rem;">1å±€ä¸Š</div>
                        <div style="font-size:0.8rem; color:#ef5350;">LIVE</div>
                    </div>
                    <div style="font-size: 2.5rem; font-weight: bold; text-align: center; color:var(--my-team-color)" id="score-h">0</div>
                </div>

                <div style="background: #2e7d32; height: 180px; position: relative; border: 3px solid #1b5e20; border-radius: 8px; margin-bottom: 10px; overflow: hidden;">
                    <div class="base b1" id="base-1" style="position: absolute; width: 20px; height: 20px; transform: rotate(45deg); right: 28%; top: 50%; background: rgba(255,255,255,0.8); border: 2px solid #aaa;"></div>
                    <div class="base b2" id="base-2" style="position: absolute; width: 20px; height: 20px; transform: rotate(45deg); left: 50%; top: 20%; margin-left: -10px; background: rgba(255,255,255,0.8); border: 2px solid #aaa;"></div>
                    <div class="base b3" id="base-3" style="position: absolute; width: 20px; height: 20px; transform: rotate(45deg); left: 28%; top: 50%; background: rgba(255,255,255,0.8); border: 2px solid #aaa;"></div>
                    <div style="position:absolute; bottom:5px; right:5px; font-family:monospace; background:rgba(0,0,0,0.7); padding:3px; border-radius:3px; font-size:0.8rem;">
                        S:<span id="cnt-s">0</span> B:<span id="cnt-b">0</span> O:<span id="cnt-o">0</span>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; background:#333; padding:5px; border-radius:5px; font-size:0.85rem; margin-bottom:5px;">
                    <span>æŠ•: <strong id="curr-p" style="color:white">---</strong></span>
                    <span>æ‰“: <strong id="curr-b" style="color:white">---</strong></span>
                </div>

                <div id="play-log">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æ¯”è³½...</div>
                <button class="btn btn-play" id="btn-start" onclick="startGame()">ğŸ“¡ é–‹å§‹æ¯”è³½ (æ¶ˆè€—é«”åŠ›)</button>
            </div>

            <div class="panel">
                <h3>ğŸ  æˆ‘æ–¹ç‹€æ…‹</h3>
                <div style="margin-bottom:10px;">
                    <div style="font-size:0.85rem; color:#aaa;">ç•¶å‰é€²æ”»/å®ˆå‚™çƒå“¡:</div>
                    <div id="my-current-action" style="font-weight:bold; color:white;">---</div>
                </div>
                
                <div style="font-size:0.85rem; margin-bottom:5px;">ç›®å‰æˆ‘æ–¹æŠ•æ‰‹é«”åŠ›ï¼š</div>
                <div id="my-pitcher-sta" style="height:10px; background:#444; border-radius:5px; overflow:hidden; margin-bottom:15px;">
                    <div style="width:100%; height:100%; background:#4caf50;"></div>
                </div>
                <div style="font-size:0.85rem; color:#aaa;">ç‰›æ£šå¾…å‘½ï¼š</div>
                <div id="bullpen-display" style="font-size:0.8rem;"></div>
                <hr style="border-color:#444; margin:10px 0;">
                <div style="font-size:0.85rem; color:var(--accent);">ğŸ“£ æ‡‰æ´ä¸­ï¼š</div>
                <div id="active-cheer" style="font-size:0.8rem;"></div>
            </div>
        </div>
    </div>

    <div id="tab-scout" style="display: none; margin-top: 15px;">
        <div class="panel" style="max-width: 600px; margin: 0 auto; text-align: center;">
            <h3>ğŸ’ ç¶œåˆçƒæ¢ä¸­å¿ƒ</h3>
            <p style="color:#aaa; font-size:0.9rem;">
                åŒ…å«ï¼šæ­·å²åå°‡(SSR)ã€ç¾å½¹çƒæ˜Ÿã€<b>è·¨ç•Œå•¦å•¦éšŠ(ç±ƒçƒ/æ£’çƒ/æ¼”è—)</b><br>
                <span style="color:var(--accent)">â˜… å•¦å•¦éšŠå°ˆå±¬æ•ˆæœï¼šæ¢å¾©é«”åŠ›ã€æ¸›å°‘å—å‚·ï¼Œå¯åˆæˆå‡ç´šã€‚</span>
            </p>
            <div class="gacha-buttons">
                <button class="btn btn-gacha btn-single" onclick="gacha()">âœ¨ å–®æŠ½ $1000</button>
                <button class="btn btn-gacha btn-ten" onclick="gachaTen()">ğŸŒŸ åé€£æŠ½ $10000 (ä¿åº• SSR)</button>
            </div>
            <div class="gacha-box" id="gacha-result"></div>
        </div>
    </div>
</div>

<script>
// ================= 1. é¾å¤§è³‡æ–™åº«èˆ‡ä¸­æ–‡åŒ– =================

const POS_ZH = {
    'P': 'æŠ•æ‰‹', 'C': 'æ•æ‰‹', '1B': 'ä¸€å£˜æ‰‹', '2B': 'äºŒå£˜æ‰‹', '3B': 'ä¸‰å£˜æ‰‹',
    'SS': 'æ¸¸æ“Šæ‰‹', 'LF': 'å·¦å¤–é‡', 'CF': 'ä¸­å¤–é‡', 'RF': 'å³å¤–é‡', 'DH': 'æŒ‡å®šæ‰“æ“Š',
    'IF': 'å…§é‡æ‰‹', 'OF': 'å¤–é‡æ‰‹' 
};
const HAND_ZH = { 'R': 'å³', 'L': 'å·¦' };

const RARITY_ORDER = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1, 'Cheer': 0 }; 

// ç¨€æœ‰åº¦èƒ½åŠ›èª¿æ•´ä¸Šä¸‹é™ (Multiplier)
const RARITY_ADJUSTMENTS = {
    'SSR': { min: 0.97, max: 1.03 }, 
    'SR':  { min: 0.95, max: 1.01 }, 
    'R':   { min: 0.92, max: 1.00 }, 
    'N':   { min: 0.85, max: 1.00 }, 
    'Cheer': { min: 1.0, max: 1.0 },
    'Special': { min: 1.0, max: 1.0 }
};

// å°ç£ä¸»è¦çƒå ´èˆ‡å¤©æ°£æ•¸æ“š
const WEATHER_DB = [
    { 
        name: "è‡ºåŒ—å¤§å·¨è›‹", 
        effect: "Dome", 
        weather: "æ™´æœ— (å®¤å…§)", 
        wind: "ç„¡é¢¨", 
        bonus: 0, 
        singers: ["å‘¨æ°å€«", "å¼µæƒ å¦¹", "äº”æœˆå¤©", "è”¡ä¾æ—", "è•­æ•¬é¨°"] 
    },
    { 
        name: "è‡ºä¸­æ´²éš›æ£’çƒå ´", 
        effect: "Normal", 
        weather: "æ™´æœ—", 
        wind: "å¹å‘å¤–é‡", 
        bonus: 3, 
        desc: "è¼•å¾®é †é¢¨ï¼Œæœ‰åˆ©é•·æ‰“" 
    },
    { 
        name: "æ–°èŠæ£’çƒå ´", 
        effect: "Normal", 
        weather: "å¤šé›²", 
        wind: "å¹å‘å…§é‡", 
        bonus: -2, 
        desc: "è¼•å¾®é€†é¢¨ï¼Œç•¥ç‚ºæŠ‘åˆ¶é•·æ‰“" 
    },
    { 
        name: "æ¾„æ¸…æ¹–æ£’çƒå ´", 
        effect: "Normal", 
        weather: "ç‚ç†±", 
        wind: "ç„¡é¢¨", 
        bonus: 0, 
        desc: "å¤©æ°£ç‚ç†±ï¼Œé›™æ–¹é«”åŠ›æ¶ˆè€—åŠ å¿« 10%" 
    },
    { 
        name: "è‡ºå—æ£’çƒå ´", 
        effect: "Normal", 
        weather: "é™°å¤©", 
        wind: "å¹å‘å¤–é‡", 
        bonus: 2, 
        desc: "è¼•å¾®é †é¢¨" 
    },
];

const CHEER_DB = [
    {n:"æ—è¥„",t:"Dragons",r:"SSR",buff:"æ‰“æ“Š"}, {n:"æå¤šæ…§",t:"Dragons",r:"SSR",buff:"é€Ÿåº¦"},
    {n:"å³®å³®",t:"Brothers",r:"SSR",buff:"é˜²å®ˆ"}, {n:"çŸ­ä»Š",t:"Brothers",r:"SR",buff:"é«”åŠ›"},
    {n:"Yuri",t:"Lions",r:"SSR",buff:"æ‰“æ“Š"}, {n:"ç‘Ÿä¸ƒ",t:"Lions",r:"SR",buff:"é«”åŠ›"},
    {n:"æ…ˆå¦¹",t:"Guardians",r:"SR",buff:"é€Ÿåº¦"}, {n:"ä¸¹ä¸¹",t:"Guardians",r:"SR",buff:"é˜²å®ˆ"},
    {n:"ç±ƒç±ƒ",t:"Monkeys",r:"SSR",buff:"å…¨èƒ½"}, {n:"ç³å¦²",t:"Monkeys",r:"SR",buff:"æ‰“æ“Š"},
    {n:"ä¸€ç²’",t:"Hawks",r:"SR",buff:"é€Ÿåº¦"}, {n:"å®‰èŠå„‡",t:"Hawks",r:"SSR",buff:"å…¨èƒ½"},
    {n:"æ¢“æ¢“",t:"Formosa Sexy",r:"SSR",buff:"é˜²å®ˆ"}, {n:"å£¯å£¯",t:"Formosa Sexy",r:"SR",buff:"é«”åŠ›"},
    {n:"Mina",t:"Taishin Wonders",r:"SR",buff:"é€Ÿåº¦"}, {n:"Faye",t:"Pilots Crew",r:"SR",buff:"æ‰“æ“Š"}
];

const TEAMS = {
    "brothers": { name: "ä¸­ä¿¡å…„å¼Ÿ", logo: "ğŸ˜", cheers:["å³®å³®","çŸ­ä»Š","æ³¢æ³¢"], roster: [
        {n:"å¾·ä¿æ‹‰",p:"P",r:"SSR"}, {n:"çŒ›ç™»",p:"P",r:"SR"}, {n:"æ±Ÿå¤å®‡",p:"SS",r:"SSR"}, {n:"ç‹å¨æ™¨",p:"3B",r:"SR"}, {n:"é™³ä¿Šç§€",p:"1B",r:"SR"}, {n:"å²³æ±è¯",p:"2B",r:"R"}, {n:"æ›¾é Œæ©",p:"RF",r:"SR"}, {n:"å²³æ”¿è¯",p:"CF",r:"R"}, {n:"é«˜å®‡æ°",p:"C",r:"R"}, {n:"è©¹å­è³¢",p:"LF",r:"R"}
    ]},
    "lions": { name: "çµ±ä¸€ç…", logo: "ğŸ¦", cheers:["Yuri","ç‘Ÿä¸ƒ","è‰¾ç’"], roster: [
        {n:"å‹é¨å£«",p:"P",r:"SSR"}, {n:"å¤æ—ç¿ç…¬",p:"P",r:"SSR"}, {n:"é™³å‚‘æ†²",p:"CF",r:"SSR"}, {n:"æ—å®‰å¯",p:"RF",r:"SSR"}, {n:"é‚±æ™ºå‘ˆ",p:"LF",r:"SR"}, {n:"é™³é‡ç¾½",p:"C",r:"R"}, {n:"æ—ç›Šå…¨",p:"1B",r:"R"}, {n:"æ½˜å‚‘æ¥·",p:"3B",r:"R"}, {n:"é™³è–å¹³",p:"SS",r:"R"}, {n:"é™³é‡å»·",p:"2B",r:"N"}
    ]},
    "dragons": { name: "å‘³å…¨é¾", logo: "ğŸ²", cheers:["æ—è¥„","æå¤šæ…§","å°æ˜ "], roster: [
        {n:"å¾è‹¥ç†™",p:"P",r:"SSR"}, {n:"é‹¼é¾",p:"P",r:"SR"}, {n:"å‰åŠ›å‰æ’ˆ",p:"C",r:"SSR"}, {n:"æå‡±å¨",p:"2B",r:"SR"}, {n:"éƒ­å¤©ä¿¡",p:"CF",r:"SR"}, {n:"åŠ‰åŸºé´»",p:"3B",r:"SR"}, {n:"æ‹¿è«ä¼Šæ¼¾",p:"1B",r:"R"}, {n:"å¼µæ”¿ç¦¹",p:"SS",r:"R"}, {n:"æ—å­ç¨‹",p:"LF",r:"R"}, {n:"å¼µç¥éŠ˜",p:"RF",r:"N"}
    ]},
    "guardians": { name: "å¯Œé‚¦æ‚å°‡", logo: "ğŸ›¡ï¸", cheers:["æ…ˆå¦¹","ä¸¹ä¸¹","ç§€ç§€å­"], roster: [
        {n:"ç¾…æˆˆ",p:"P",r:"SSR"}, {n:"å¯Œè—æˆˆ",p:"P",r:"SR"}, {n:"å¼µè‚²æˆ",p:"SS",r:"SSR"}, {n:"æˆ´åŸ¹å³°",p:"C",r:"SR"}, {n:"èŒƒåœ‹å®¸",p:"1B",r:"R"}, {n:"ç‹æ­£æ£ ",p:"2B",r:"SR"}, {n:"ç”³çš“ç‘‹",p:"CF",r:"R"}, {n:"æå®—è³¢",p:"3B",r:"R"}, {n:"å­”å¿µæ©",p:"RF",r:"N"}, {n:"é™³çœŸ",p:"LF",r:"N"}
    ]},
    "monkeys": { name: "æ¨‚å¤©æ¡ƒçŒ¿", logo: "ğŸ¦", cheers:["ç±ƒç±ƒ","ç³å¦²","Yuri"], roster: [
        {n:"å¨èƒ½å¸",p:"P",r:"SSR"}, {n:"é»ƒå­éµ¬",p:"P",r:"SR"}, {n:"æ—ç«‹",p:"2B",r:"SSR"}, {n:"æœ±è‚²è³¢",p:"1B",r:"SR"}, {n:"é™³æ™¨å¨",p:"CF",r:"SR"}, {n:"æ¢å®¶æ¦®",p:"3B",r:"SR"}, {n:"å»–å¥å¯Œ",p:"DH",r:"SR"}, {n:"é¦¬å‚‘æ£®",p:"SS",r:"R"}, {n:"å®‹å˜‰ç¿”",p:"C",r:"R"}, {n:"æˆæ™‰",p:"RF",r:"N"}
    ]},
    "hawks": { name: "å°é‹¼é›„é·¹", logo: "ğŸ¦…", cheers:["å®‰èŠå„‡","ä¸€ç²’","Mingo"], roster: [
        {n:"é­”é·¹",p:"1B",r:"SSR"}, {n:"å³å¿µåº­",p:"3B",r:"SR"}, {n:"ç‹æŸè",p:"DH",r:"SR"}, {n:"å“ˆç‘ªæ˜Ÿ",p:"P",r:"SR"}, {n:"æ±Ÿæ‰¿è«º",p:"P",r:"R"}, {n:"æ›¾å­ç¥",p:"SS",r:"R"}, {n:"é™³æ–‡æ°",p:"CF",r:"R"}, {n:"å¼µè‚‡å…ƒ",p:"C",r:"R"}, {n:"æœå®¶æ˜",p:"2B",r:"N"}, {n:"è—å¯…å€«",p:"LF",r:"N"}
    ]}
};

const HISTORY = [
    {n:"ç‹å»ºæ°‘",p:"P",r:"SSR"}, {n:"å½­æ”¿é–”",p:"1B",r:"SSR"}, {n:"é»ƒå¹³æ´‹",p:"P",r:"SSR"}, 
    {n:"å¼µæ³°å±±",p:"3B",r:"SR"}, {n:"æ—æ™ºå‹",p:"SS",r:"SR"}
];

// æ—…å¤–æ€ªç‰©éšŠä¼
const OVERSEAS_ALLSTARS = {
    name: "ğŸ‡¹ğŸ‡¼ æ—…å¤–æ€ªç‰©éšŠ", logo: "â­", 
    roster: [
        {n:"é™³é‡‘é‹’",p:"DH",r:"SSR"}, {n:"éƒ­æ³“å¿—",p:"P",r:"SSR"}, {n:"ç‹æŸè",p:"LF",r:"SSR"}, 
        {n:"å¼µè‚²æˆ",p:"SS",r:"SSR"}, {n:"é™³å‰æ®·",p:"P",r:"SSR"}, {n:"æ—å­å‰",p:"CF",r:"SSR"},
    ]
};


// ================= 2. ç³»çµ±ç‹€æ…‹ =================
let money = 1000000; 
let myRoster = []; 
let lineup = new Array(9).fill(null);
let rotation = { SP:null, RP1:null, RP2:null, CP:null };
let activeCheers = [null, null, null]; 
let cheerMultipliers = {}; // { cheerName: level }

let game = { active:false, inning:1, top:true, outs:0, bases:[0,0,0], score:{a:0,h:0}, batIdx:{a:0,h:0}, counts:{s:0, b:0} };
let opponent = { name:"", lineup:[], pitcher:null };
let currentPitcher = null; 
let gameWeather = null; 

// éš¨æ©Ÿç”¢ç”Ÿæ…£ç”¨æ‰‹ (R: å³, L: å·¦)
function getRandomHand() {
    return Math.random() < 0.8 ? 'R' : 'L'; 
}

function genStats(r) {
    let base = r==="SSR"?92 : r==="SR"?82 : r==="R"?72 : 62;
    let rand = ()=>Math.floor(Math.random()*10);
    let s = { 
        con:base+rand(), pwr:base+rand(), spd:base+rand(), def:base+rand(), stu:base+rand(), 
        total:0, // åˆå§‹æ•¸å€¼ (ä¸å—ä¹˜æ•¸å½±éŸ¿)
        multiplier: 1.0 // ä¹˜æ•¸ï¼Œç”¨æ–¼åˆæˆå‡ç´š
    };
    s.total = Math.floor((s.con+s.pwr+s.spd+s.def)/4);
    return s;
}

function createUnit(data, type='player') {
    let u = {
        id: Math.random().toString(36).substr(2,9), name: data.n, type: type, rarity: data.r || "N", 
        pos: data.p || "Cheer", stamina: 100, injury: 0,
        level: data.level || 0,
        hand: getRandomHand()
    };
    if(type==='player') {
        u.stats = data.stats ? {...data.stats} : genStats(u.rarity);
        // å¦‚æœæ˜¯å¾ç¾æœ‰æ•¸æ“šå‰µå»ºï¼Œç¢ºä¿ä¹˜æ•¸å­˜åœ¨
        if (!u.stats.multiplier) u.stats.multiplier = 1.0; 
        
        // é‡æ–°è¨ˆç®— total (åƒ…ç”¨æ–¼é¡¯ç¤º)
        let total = (u.stats.con+u.stats.pwr+u.stats.spd+u.stats.def)/4;
        u.stats.total = Math.floor(total * u.stats.multiplier);

    } else { // Cheer
        u.buff = data.buff || "å£«æ°£";
        if (!cheerMultipliers[u.name]) cheerMultipliers[u.name] = 1; // åŸºç¤å€ç‡
        u.level = data.level || 0; // å•¦å•¦éšŠç­‰ç´š
    }
    return u;
}

// ç²å–çƒå“¡çš„æœ€çµ‚èƒ½åŠ›å€¼ (æ‡‰ç”¨ä¹˜æ•¸)
function getFinalPlayerStat(player, statKey) {
    if (!player || !player.stats) return 0;
    const baseStat = player.stats[statKey];
    const multiplier = player.stats.multiplier;
    return Math.floor(baseStat * multiplier);
}

// ================= 3. åˆå§‹åŒ–èˆ‡ UI æ¸²æŸ“ =================

function init() {
    const grid = document.getElementById('team-list');
    for(let k in TEAMS) {
        let t = TEAMS[k];
        grid.innerHTML += `
            <div class="team-card" onclick="selectTeam('${k}')">
                <div class="team-logo">${t.logo}</div>
                <h3>${t.name}</h3>
            </div>`;
    }
}

function selectTeam(key) {
    let t = TEAMS[key];
    
    myRoster = [];
    lineup = new Array(9).fill(null);
    rotation = { SP:null, RP1:null, RP2:null, CP:null };
    activeCheers = [null, null, null];
    cheerMultipliers = {}; // æ¸…ç©ºä¸¦é‡æ–°è¨ˆç®—

    // åˆå§‹æ ¸å¿ƒçƒå“¡
    t.roster.forEach(p => myRoster.push(createUnit(p)));
    
    // å¢åŠ æ¿å‡³çƒå“¡
    for(let i=0; i<12; i++) {
        let pos;
        if (i < 4) pos = 'P'; 
        else if (i < 8) pos = 'IF';
        else pos = 'OF'; 
        myRoster.push(createUnit({n:`äºŒè»${i}`,p:pos,r:'N'}));
    }
    
    // åˆå§‹å•¦å•¦éšŠ
    t.cheers.forEach(cName => {
        let cData = CHEER_DB.find(x => x.n === cName) || {n:cName, r:"R", buff:"å£«æ°£"};
        myRoster.push(createUnit(cData, 'cheer'));
        cheerMultipliers[cName] = 1;
    });
    
    // åˆå§‹SSRå¤§ç¦®åŒ…
    let gift = HISTORY[Math.floor(Math.random()*HISTORY.length)];
    myRoster.push(createUnit(gift));

    autoLineup();

    document.getElementById('screen-select').classList.remove('active');
    document.getElementById('screen-main').classList.add('active');
    renderUI();
}

function renderUI() {
    renderLineupTable();
    renderRotationTable();
    renderCheerSlots();
    renderCheerList(); 
    renderRosterList();
    renderFusionCenter(); 
    document.getElementById('money-val').innerText = `$${money.toLocaleString()}`;
}

/**
 * æ ¸å¿ƒé‡è¤‡æª¢æŸ¥ï¼šç²å–æ‰€æœ‰åœ¨ã€æ‰“ç·šã€‘ã€ã€æŠ•æ‰‹è¼ªå€¼ã€‘å’Œã€æ‡‰æ´åœ˜ã€‘ä¸­å·²ä½¿ç”¨çš„çƒå“¡/å•¦å•¦éšŠçš„ IDã€‚
 */
function getUsedIDs() {
    const usedIDs = new Set();
    lineup.filter(p => p).forEach(p => usedIDs.add(p.id));
    Object.values(rotation).filter(p => p).forEach(p => usedIDs.add(p.id));
    activeCheers.slice(0, 3).filter(c => c).forEach(c => usedIDs.add(c.id));
    
    // åŒ…å«å¤§å·¨è›‹ç‰¹æ®Šå•¦å•¦éšŠ ID (è‹¥æœ‰)
    if (activeCheers.length > 3 && activeCheers[3]) {
        usedIDs.add(activeCheers[3].id);
    }

    return usedIDs;
}

/**
 * æª¢æŸ¥ç•¶å‰é™£å®¹ä¸­å·²ä½¿ç”¨çš„ SSR æ•¸é‡
 */
function getUsedSSRCount() {
    let ssrCount = 0;
    // æª¢æŸ¥æ‰“ç·š
    lineup.filter(p => p && p.rarity === 'SSR').forEach(() => ssrCount++);
    // æª¢æŸ¥æŠ•æ‰‹è¼ªå€¼
    Object.values(rotation).filter(p => p && p.rarity === 'SSR').forEach(() => ssrCount++);
    
    return ssrCount;
}

// æ¸²æŸ“æ‰“ç·šè¡¨æ ¼ (æª¢æŸ¥ ID é‡è¤‡ + SSR é™åˆ¶)
function renderLineupTable() {
    const tb = document.querySelector('#lineup-table tbody');
    tb.innerHTML = "";
    
    const maxSSR = 2;
    const currentSSRCount = getUsedSSRCount();
    
    for(let i=0; i<9; i++) {
        let curr = lineup[i];
        let usedIDs = getUsedIDs(); 
        let opts = `<option value="-1">-- ç©ºç¼º --</option>`;
        let list = myRoster.filter(p => p.type==='player' && p.pos!=='P');
        
        list.forEach(p => {
            // æª¢æŸ¥ 1: å¡ç‰‡æ˜¯å¦å·²åœ¨å…¶ä»–é™£å®¹/è¼ªå€¼/æ‡‰æ´åœ˜ä½¿ç”¨
            let isUsedElsewhere = usedIDs.has(p.id) && (!curr || curr.id!==p.id);
            // æª¢æŸ¥ 2: æ˜¯å¦è¶…é SSR é™åˆ¶ (å¦‚æœè©²å¡æ˜¯ SSR ä¸”é™£å®¹ä¸­å·²æœ‰ 2 å¼µ SSRï¼Œä¸”å®ƒä¸æ˜¯ç•¶å‰é¸ä¸­çš„å¡)
            let isSSRRestricted = (p.rarity === 'SSR' && currentSSRCount >= maxSSR && (!curr || curr.id!==p.id));
            
            if(isUsedElsewhere) return; // å·²ä½¿ç”¨å‰‡è·³é (å› ç‚º ID å”¯ä¸€)
            
            let disabled = (p.injury > 0) ? 'disabled' : isSSRRestricted ? 'disabled' : '';
            let injTxt = p.injury > 0 ? ` (å‚·${p.injury}å ´)` : '';
            let restrictTxt = isSSRRestricted ? ' (SSRå·²æ»¿)' : '';
            let pos_zh = POS_ZH[p.pos] || p.pos;
            let total = getFinalPlayerStat(p, 'total');
            let sel = (curr&&curr.id===p.id)?'selected':'';
            
            opts += `<option value="${p.id}" ${sel} ${disabled}>
                ${p.name} Lv.${p.level} (${pos_zh} / ${HAND_ZH[p.hand]}) - è©•:${total} é«”:${p.stamina.toFixed(0)}${injTxt}${restrictTxt}
            </option>`;
        });
        tb.innerHTML += `<tr><td>${i+1}æ£’</td><td><select onchange="setLineup(${i},this.value)">${opts}</select></td></tr>`;
    }
}

// æ¸²æŸ“æŠ•æ‰‹è¼ªå€¼è¡¨æ ¼ (æª¢æŸ¥ ID é‡è¤‡ + SSR é™åˆ¶)
function renderRotationTable() {
    const tb = document.querySelector('#rotation-table tbody');
    tb.innerHTML = "";

    const maxSSR = 2;
    const currentSSRCount = getUsedSSRCount();

    ['SP','RP1','RP2','CP'].forEach(role => {
        let curr = rotation[role];
        let usedIDs = getUsedIDs(); 
        let opts = `<option value="-1">-- ç©ºç¼º --</option>`;
        let list = myRoster.filter(p => p.type==='player' && p.pos==='P');
        
        list.forEach(p => {
            let isUsedElsewhere = usedIDs.has(p.id) && (!curr || curr.id!==p.id);
            // æª¢æŸ¥ 2: æ˜¯å¦è¶…é SSR é™åˆ¶ (å¦‚æœè©²å¡æ˜¯ SSR ä¸”é™£å®¹ä¸­å·²æœ‰ 2 å¼µ SSRï¼Œä¸”å®ƒä¸æ˜¯ç•¶å‰é¸ä¸­çš„å¡)
            let isSSRRestricted = (p.rarity === 'SSR' && currentSSRCount >= maxSSR && (!curr || curr.id!==p.id));

            if(isUsedElsewhere) return;
            
            let disabled = (p.injury > 0) ? 'disabled' : isSSRRestricted ? 'disabled' : '';
            let injTxt = p.injury > 0 ? ` (å‚·${p.injury}å ´)` : '';
            let restrictTxt = isSSRRestricted ? ' (SSRå·²æ»¿)' : '';
            let totalStu = getFinalPlayerStat(p, 'stu');
            let sel = (curr&&curr.id===p.id)?'selected':'';
            
            opts += `<option value="${p.id}" ${sel} ${disabled}>
                ${p.name} Lv.${p.level} (${HAND_ZH[p.hand]}) - å¨:${totalStu} é«”:${p.stamina.toFixed(0)}${injTxt}${restrictTxt}
            </option>`;
        });
        tb.innerHTML += `<tr><td>${role}</td><td><select onchange="setRot('${role}',this.value)">${opts}</select></td></tr>`;
    });
}

// æ¸²æŸ“å•¦å•¦éšŠ (æª¢æŸ¥ ID é‡è¤‡)
function renderCheerSlots() {
    const div = document.getElementById('cheer-slots');
    div.innerHTML = "";
    for(let i=0; i<3; i++) {
        let curr = activeCheers[i];
        let usedIDs = getUsedIDs(); 
        let opts = `<option value="-1">-- ç„¡ --</option>`;
        let list = myRoster.filter(u => u.type==='cheer');
        list.forEach(c => {
            let isUsedElsewhere = usedIDs.has(c.id) && (!curr || curr.id!==c.id);
            if(isUsedElsewhere) return;
            
            const cheerLevel = cheerMultipliers[c.name] || 1;
            const buffClass = cheerLevel >= 4 ? 'cheer-buff-lv4' : cheerLevel >= 3 ? 'cheer-buff-lv3' : cheerLevel >= 2 ? 'cheer-buff-lv2' : 'cheer-buff-lv1';
            const buffText = `Lv.${cheerLevel} (${((cheerLevel - 1) * 100).toFixed(0)}% Buff)`;

            let sel = (curr&&curr.id===c.id)?'selected':'';
            opts += `<option value="${c.id}" ${sel}><span class="${buffClass}">${c.name} [${c.buff}] ${buffText}</span></option>`;
        });
        div.innerHTML += `<div style="margin-bottom:5px;"><select onchange="setCheer(${i},this.value)">${opts}</select></div>`;
    }
}

// ç¶å®šé¸å–®äº‹ä»¶ï¼Œä¸¦é‡æ–°æ¸²æŸ“ UI ä»¥æ›´æ–°é‡è¤‡æª¢æŸ¥å’Œ SSR é™åˆ¶
function setLineup(i, id) { 
    const newUnit = id==="-1"?null:myRoster.find(u=>u.id===id);
    const oldUnit = lineup[i];

    if (newUnit && newUnit.rarity === 'SSR') {
        const currentSSRCount = getUsedSSRCount();
        if (currentSSRCount >= 2 && (!oldUnit || oldUnit.rarity !== 'SSR')) {
            alert("SSR é™åˆ¶ï¼šæ‰“ç·šå’ŒæŠ•æ‰‹è¼ªå€¼ç¸½è¨ˆæœ€å¤šåªèƒ½æœ‰ 2 å¼µ SSR å¡ç‰‡ä¸Šå ´ã€‚è«‹å…ˆç§»é™¤å…¶ä»– SSR å¡ç‰‡ã€‚");
            return;
        }
    }

    lineup[i] = newUnit; 
    renderUI(); 
}
function setRot(r, id) { 
    const newUnit = id==="-1"?null:myRoster.find(u=>u.id===id);
    const oldUnit = rotation[r];
    
    if (newUnit && newUnit.rarity === 'SSR') {
        const currentSSRCount = getUsedSSRCount();
        if (currentSSRCount >= 2 && (!oldUnit || oldUnit.rarity !== 'SSR')) {
            alert("SSR é™åˆ¶ï¼šæ‰“ç·šå’ŒæŠ•æ‰‹è¼ªå€¼ç¸½è¨ˆæœ€å¤šåªèƒ½æœ‰ 2 å¼µ SSR å¡ç‰‡ä¸Šå ´ã€‚è«‹å…ˆç§»é™¤å…¶ä»– SSR å¡ç‰‡ã€‚");
            return;
        }
    }
    
    rotation[r] = newUnit; 
    renderUI(); 
}
function setCheer(i, id) { activeCheers[i] = id==="-1"?null:myRoster.find(u=>u.id===id); renderUI(); }


// å¯¦ä½œä¸€éµæ¸…ç©ºæ‰€æœ‰é™£å®¹
function clearAllLineup() {
    if (!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…ˆç™¼æ‰“ç·šã€æŠ•æ‰‹è¼ªå€¼å’Œæ‡‰æ´åœ˜çš„é…ç½®å—ï¼Ÿ")) return;
    
    lineup = new Array(9).fill(null);
    rotation = { SP:null, RP1:null, RP2:null, CP:null };
    activeCheers = [null, null, null];
    
    // ç¢ºä¿ä¸æœƒå½±éŸ¿åˆ°å¤§å·¨è›‹çš„è‡¨æ™‚ Buff æ§½ä½ (ç´¢å¼• 3)
    if (activeCheers.length > 3) {
        activeCheers[3] = null;
    }
    
    renderUI();
    log("æ‰€æœ‰é™£å®¹é…ç½®å·²æ¸…ç©ºï¼", "log-hl");
}


// --- ä»¥ä¸‹ç‚ºå…¶ä»–è¼”åŠ©å‡½æ•¸ ---

function renderCheerList() {
    const v = document.getElementById('cheer-roster-view');
    let cheerleaders = myRoster.filter(u => u.type === 'cheer');
    document.getElementById('cheer-count').innerText = cheerleaders.length;
    v.innerHTML = cheerleaders.map(c => {
        const cheerLevel = cheerMultipliers[c.name] || 1;
        const buffClass = cheerLevel >= 4 ? 'cheer-buff-lv4' : cheerLevel >= 3 ? 'cheer-buff-lv3' : cheerLevel >= 2 ? 'cheer-buff-lv2' : 'cheer-buff-lv1';
        return `<span class="cheer-item r-${c.rarity} ${buffClass}">
                 ${c.name} [${c.buff}] Lv.${cheerLevel}
                 </span>`;
    }).join('');
}

function renderRosterList() {
    const v = document.getElementById('roster-view');
    document.getElementById('roster-count').innerText = myRoster.filter(u=>u.type==='player').length;
    v.innerHTML = myRoster.map(u => {
        if(u.type === 'cheer') return "";
        let injClass = u.injury > 0 ? "injured" : "";
        let staColor = u.stamina > 80 ? "#4caf50" : u.stamina > 40 ? "#ff9800" : "#f44336";
        let pos_zh = POS_ZH[u.pos] || u.pos;
        let total = getFinalPlayerStat(u, 'total');
        let hand_zh = HAND_ZH[u.hand] || u.hand;

        return `
            <div style="background:#333; padding:5px; border-radius:4px; font-size:0.8rem; width:120px;">
                <div class="${injClass}"><span class="r-${u.rarity}">${u.name} Lv.${u.level}</span> <small>(${pos_zh} / ${hand_zh}) ${u.injury>0?'ğŸ¥'+u.injury:''}</small></div>
                <div style="display:flex; justify-content:space-between; font-size:0.75rem;">
                    <span>ç¸½è©•: ${total}</span>
                </div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <small>é«”:</small>
                    <div class="sta-bar-bg"><div class="sta-bar-fill" style="width:${u.stamina.toFixed(0)}%; background:${staColor}"></div></div>
                </div>
            </div>
        `;
    }).join('');
}


// ç²å–å¯åˆæˆçš„é‡è¤‡å¡ç‰‡
function getDuplicateUnits() {
    const roster = myRoster.filter(u => u.type === 'player' || u.type === 'cheer');
    const counts = {};
    const originals = {}; // å„²å­˜æœ€é«˜ç­‰ç´šçš„å¡ç‰‡/å•¦å•¦éšŠä½œç‚ºåŸºç¤å¡

    roster.forEach(p => {
        const key = `${p.type}_${p.name}`; 
        counts[key] = (counts[key] || 0) + 1;
        
        // æ‰¾å‡ºæœ€é«˜ç­‰ç´šçš„å¡ä½œç‚ºåŸºç¤å¡
        if (!originals[key] || p.level > originals[key].level) {
            originals[key] = p;
        }
    });

    const duplications = [];
    for (const key in counts) {
        const [type, name] = key.split('_');
        if (counts[key] >= 10) { 
            duplications.push({
                name: name,
                type: type,
                count: counts[key],
                baseUnit: originals[key]
            });
        }
    }
    return duplications;
}


function renderFusionCenter() { 
    const center = document.getElementById('fusion-center');
    const duplications = getDuplicateUnits();

    if (duplications.length === 0) {
        center.innerHTML = '<p style="color:#aaa; font-style:italic;">ç›®å‰æ²’æœ‰è¶³å¤ çš„é‡è¤‡çƒå“¡æˆ–å•¦å•¦éšŠå¯ä»¥åˆæˆã€‚</p>';
        return;
    }

    center.innerHTML = '';
    duplications.forEach(d => {
        const fusionCount = Math.floor(d.count / 10);
        const unit = d.baseUnit;
        
        // è¨ˆç®—å¯ç§»é™¤å¡ç‰‡æ•¸é‡
        const allUnits = myRoster.filter(u => u.name === unit.name && u.type === unit.type);
        const usedIDs = getUsedIDs();
        // å¯ç§»é™¤ = ç¸½æ•¸ - (åŸºç¤å¡æ•¸é‡ 1) - (å…¶ä»–åœ¨é™£å®¹ä¸­ä½¿ç”¨çš„å¡ç‰‡æ•¸é‡)
        const removableCardsCount = allUnits.filter(p => p.id !== unit.id && !usedIDs.has(p.id)).length;
        const canFuse = removableCardsCount >= (fusionCount * 10);
        
        let infoText, fuseButtonText, targetLevel, typeDisplay;
        
        if (d.type === 'player') {
            typeDisplay = POS_ZH[unit.pos] || unit.pos;
            targetLevel = unit.level + fusionCount;
            infoText = `åŸºç¤å¡ç¸½è©•: ${getFinalPlayerStat(unit, 'total')} (å¯ç§»é™¤: ${removableCardsCount} å¼µ)`;
            fuseButtonText = `çƒå“¡åˆæˆ (${fusionCount * 10} å¼µ) -> Lv.${targetLevel}`;
        } else {
            typeDisplay = unit.buff;
            targetLevel = (cheerMultipliers[unit.name] || 1) + fusionCount;
            const buffClass = targetLevel >= 4 ? 'cheer-buff-lv4' : targetLevel >= 3 ? 'cheer-buff-lv3' : targetLevel >= 2 ? 'cheer-buff-lv2' : 'cheer-buff-lv1';
            infoText = `<span class="${buffClass}">å•¦å•¦éšŠ Buff Lv.${(cheerMultipliers[unit.name] || 1)}</span> (å¯ç§»é™¤: ${removableCardsCount} å¼µ)`;
            fuseButtonText = `å•¦å•¦éšŠåˆæˆ (${fusionCount * 10} å¼µ) -> Lv.${targetLevel} (${((targetLevel - 1) * 100).toFixed(0)}% Buff)`;
        }

        center.innerHTML += `
            <div class="fusion-item">
                <div style="font-weight:bold;">
                    <span class="r-${unit.rarity}">${unit.name}</span> (${typeDisplay})
                    <div style="font-size:0.9rem;">
                        æ“æœ‰æ•¸é‡: ${d.count} å¼µ | ${infoText}
                    </div>
                </div>
                
                <button class="btn-fuse" 
                        ${canFuse ? '' : 'disabled'}
                        onclick="fuseUnit('${unit.name}', '${d.type}', ${fusionCount})">
                    ${fuseButtonText}
                </button>
            </div>
        `;
    });
}


// çƒå“¡/å•¦å•¦éšŠåˆæˆä¸»é‚è¼¯ (ä¿®æ­£ç‰ˆ)
function fuseUnit(unitName, type, fusionCount) {
    const requiredCards = fusionCount * 10;
    const allUnits = myRoster.filter(u => u.name === unitName && u.type === type);
    
    // 1. æ‰¾åˆ°åŸºç¤å¡ (æœ€é«˜ç­‰ç´š/æœ€æ–°çš„é‚£ä¸€å¼µ)
    let baseUnit = allUnits.reduce((a, b) => (a.level > b.level) ? a : b);

    // 2. ç²å–æ‰€æœ‰æ­£åœ¨é™£å®¹ä¸­ä½¿ç”¨çš„å¡ç‰‡ ID
    const usedIDs = getUsedIDs(); 
    
    // 3. éæ¿¾å‡ºå¯ç§»é™¤çš„å¡ç‰‡ï¼šä¸æ˜¯åŸºç¤å¡ï¼Œä¸” ID ä¸åœ¨é™£å®¹ä¸­
    const removableCards = allUnits.filter(p => p.id !== baseUnit.id && !usedIDs.has(p.id));
    
    if (removableCards.length < requiredCards) {
        // --- é‡å°æ‚¨çš„å•é¡Œä¿®æ­£çš„é‡é»æç¤º ---
        alert(`ğŸš¨ åˆæˆå¤±æ•—ï¼\n\næ‚¨éœ€è¦ ${requiredCards} å¼µé‡è¤‡å¡ï¼Œä½†ç›®å‰åªæœ‰ ${removableCards.length} å¼µå¡ç‰‡æ˜¯ã€éåŸºç¤å¡ã€‘ä¸”ã€æœªåœ¨é™£å®¹/è¼ªå€¼/æ‡‰æ´åœ˜ä¸­ä½¿ç”¨ã€‘ã€‚ \n\nè«‹æª¢æŸ¥é™£å®¹ä¸­æ˜¯å¦æœ‰å…¶ä»–ã€åŒåå¡ç‰‡ã€‘æ­£åœ¨ä¸Šå ´ã€‚`);
        return;
    }
    
    if (!confirm(`ç¢ºå®šæ¶ˆè€— ${requiredCards} å¼µ ${unitName} çš„å¡ç‰‡ï¼Œå°‡å…¶åˆæˆä¸¦æå‡ ${fusionCount} ç´šå—ï¼Ÿ`)) {
        return;
    }

    
    // 4. ç§»é™¤å¡ç‰‡
    const idsToRemove = removableCards.slice(0, requiredCards).map(c => c.id);
    myRoster = myRoster.filter(p => !idsToRemove.includes(p.id));

    // 5. å‡ç´šåŸºç¤å¡ç‰‡
    if (type === 'player') {
        const oldTotal = getFinalPlayerStat(baseUnit, 'total');
        baseUnit.level += fusionCount;
        
        // --- æ ¸å¿ƒä¿®æ­£ï¼š+1% ä¹˜æ•¸ ---
        baseUnit.stats.multiplier += (0.01 * fusionCount); 

        // é‡æ–°è¨ˆç®—ç¸½è©•
        const newTotal = getFinalPlayerStat(baseUnit, 'total');
        
        alert(`ğŸ‰ åˆæˆæˆåŠŸï¼${unitName} æå‡ ${fusionCount} ç´šï¼Œç›®å‰ç­‰ç´š Lv.${baseUnit.level}ï¼(ç¸½è©•æå‡è‡³ ${newTotal})`);
    
    } else if (type === 'cheer') {
        // --- å•¦å•¦éšŠåˆæˆé‚è¼¯ ---
        cheerMultipliers[unitName] = (cheerMultipliers[unitName] || 1) + fusionCount;
        baseUnit.level = cheerMultipliers[unitName] - 1; // é¡¯ç¤ºç­‰ç´š
        const newLevel = cheerMultipliers[unitName];
        alert(`ğŸ“£ å•¦å•¦éšŠåˆæˆæˆåŠŸï¼${unitName} çš„ Buff æ•ˆæœæå‡è‡³ Lv.${newLevel}ï¼`);
    }

    renderUI();
}


function autoLineup() {
    // ç¢ºä¿é™£å®¹æ˜¯ç©ºçš„ï¼Œé€™æ¨£æ‰èƒ½é‡æ–°å¡«å……
    lineup = new Array(9).fill(null);
    rotation = { SP:null, RP1:null, RP2:null, CP:null };
    activeCheers = [null, null, null];
    
    // å–å¾—æ‰€æœ‰æœªå—å‚·çš„çƒå“¡/å•¦å•¦éšŠ
    let allAvailable = myRoster.filter(u => u.injury === 0);
    
    // å„²å­˜å·²ä½¿ç”¨çš„å¡ç‰‡ ID
    let currentUsedIDs = new Set();
    let ssrCount = 0;
    const maxSSR = 2;

    // 1. å¡«å……æ‰“ç·š (æœ€é«˜ç¸½è©•)
    let availableHitters = allAvailable.filter(p => p.type === 'player' && p.pos !== 'P')
        .sort((a,b) => getFinalPlayerStat(b, 'total') - getFinalPlayerStat(a, 'total'));
    
    for(let i=0; i<9; i++) {
        let bestPlayer = availableHitters.find(p => {
            if (currentUsedIDs.has(p.id)) return false;
            if (p.rarity === 'SSR' && ssrCount >= maxSSR) return false;
            return true;
        });
        
        if (bestPlayer) {
            lineup[i] = bestPlayer;
            currentUsedIDs.add(bestPlayer.id);
            if (bestPlayer.rarity === 'SSR') ssrCount++;
        }
    }
    
    // 2. å¡«å……æŠ•æ‰‹ (æœ€é«˜ Stuff)
    let availablePitchers = allAvailable.filter(p => p.type === 'player' && p.pos === 'P')
        .sort((a,b) => getFinalPlayerStat(b, 'stu') - getFinalPlayerStat(a, 'stu'));

    let pitcherSlots = ['SP', 'RP1', 'RP2', 'CP'];
    pitcherSlots.forEach(role => {
        let bestPitcher = availablePitchers.find(p => {
            if (currentUsedIDs.has(p.id)) return false;
            if (p.rarity === 'SSR' && ssrCount >= maxSSR) return false;
            return true;
        });
        
        if (bestPitcher) {
            rotation[role] = bestPitcher;
            currentUsedIDs.add(bestPitcher.id);
            if (bestPitcher.rarity === 'SSR') ssrCount++;
        }
    });

    // 3. å¡«å……å•¦å•¦éšŠ (æœ€é«˜ Buff ç­‰ç´š)
    let availableCheers = allAvailable.filter(u => u.type === 'cheer')
        .sort((a, b) => (cheerMultipliers[b.name] || 1) - (cheerMultipliers[a.name] || 1));

    for (let i = 0; i < 3; i++) {
        let bestCheer = availableCheers.find(c => !currentUsedIDs.has(c.id));
        if (bestCheer) {
            activeCheers[i] = bestCheer;
            currentUsedIDs.add(bestCheer.id);
        }
    }

    renderUI();
    log(`é™£å®¹å·²ä¸€éµæœ€ä½³åŒ–ã€‚ä¸Šå ´ SSR æ•¸: ${ssrCount}/${maxSSR}`, "log-hl");
}


// --- éŠæˆ²é‚è¼¯ï¼ˆç›¸å‰‹/Buff æ‡‰ç”¨ï¼‰ ---
// ä¿®æ­£ getAdjustedStatValue ä»¥æ‡‰ç”¨çƒå“¡ä¹˜æ•¸å’Œå•¦å•¦éšŠä¹˜æ•¸

function getCheerMultiplier() {
    let multiplier = 1.0;
    activeCheers.filter(c => c).forEach(c => {
        const cheerLevel = cheerMultipliers[c.name] || 1;
        // å•¦å•¦éšŠç­‰ç´š Buff: åŸºç¤ + (ç­‰ç´š-1) * 1%
        multiplier += (cheerLevel - 1) * 0.01;
    });
    // å¤§å·¨è›‹è‡¨æ™‚ Buff (è‹¥å­˜åœ¨)
    if (activeCheers.length > 3 && activeCheers[3]) multiplier += 0.05; 
    return multiplier;
}

function getAdjustedStatValue(unit, statKey, handMatchup = 'Neutral', isPitcher=false) {
    
    // 1. æ‡‰ç”¨çƒå“¡æœ¬èº«çš„ä¹˜æ•¸ (åˆæˆå¢ç›Š)
    let statValue = unit.stats[statKey];
    let multiplier = unit.stats.multiplier || 1.0;
    
    // 2. æ‡‰ç”¨ç¨€æœ‰åº¦æµ®å‹•
    const bounds = RARITY_ADJUSTMENTS;
    const { min, max } = bounds[unit.rarity] || { min: 1.0, max: 1.0 };
    multiplier *= (min + Math.random() * (max - min)); 
    
    // 3. å•¦å•¦éšŠ Buff æ‡‰ç”¨ (åƒ…å½±éŸ¿æˆ‘æ–¹æ‰“è€…èƒ½åŠ›)
    if (!isPitcher && !game.top) { // æˆ‘æ–¹é€²æ”»æ™‚
        let cheerMult = getCheerMultiplier();
        if (statKey === 'con' || statKey === 'pwr' || statKey === 'spd' || statKey === 'def') {
            multiplier *= cheerMult;
        }
    }
    
    // 4. å¤©æ°£/é¢¨å‘å½±éŸ¿ (åƒ…å½±éŸ¿æ‰“è€…åŠ›é‡)
    if (!isPitcher && statKey === 'pwr' && gameWeather.effect !== "Dome") {
        if (gameWeather.wind === "å¹å‘å¤–é‡") multiplier *= (1 + (gameWeather.bonus / 100));
        if (gameWeather.wind === "å¹å‘å…§é‡") multiplier *= (1 - (Math.abs(gameWeather.bonus) / 100));
    }
    
    // 5. å·¦å³æŠ•/æ‰“ç›¸å‰‹å½±éŸ¿ (å½±éŸ¿æ‰“è€…èƒ½åŠ›)
    if (!isPitcher) {
        if (handMatchup === 'Conflict') multiplier *= 0.97;
        else if (handMatchup === 'Advantage') multiplier *= 1.02; 
    }
    
    return Math.round(statValue * multiplier);
}

// ------------------------------------
// å…¶ä»–éŠæˆ²é‚è¼¯ (æ²¿ç”¨ V4)
// ------------------------------------

function startGame() {
    if(lineup.includes(null)) { log("ğŸš¨ æ‰“ç·šä¸å®Œæ•´ï¼Œè«‹è£œæ»¿ 9 æ£’å†é–‹å§‹ã€‚", "log-error"); return; }
    if(!rotation.SP) { log("ğŸš¨ ç„¡å…ˆç™¼æŠ•æ‰‹ï¼Œè«‹é¸æ“‡å…ˆç™¼æŠ•æ‰‹ã€‚", "log-error"); return; }
    
    let requiredP = ['RP1','RP2','CP'].filter(r => rotation[r] === null);
    if(requiredP.length > 0) {
        if(!confirm(`ç‰›æ£šç¼ºå°‘ ${requiredP.join('/')}ï¼Œå¯èƒ½æœƒè®“å…ˆç™¼æŠ•æ‰‹éåº¦å‹ç´¯ã€‚ç¢ºå®šé–‹å§‹å—ï¼Ÿ`)) return; 
    }
    
    if(rotation.SP.stamina < 30) { 
        if(!confirm("å…ˆç™¼æŠ•æ‰‹é«”åŠ›æ¥µä½ï¼å¼·è¡Œå‡ºè³½æ¥µå¯èƒ½å—å‚·ï¼Œç¢ºå®šå—ï¼Ÿ")) return; 
    }
    
    initWeatherAndField();

    game.active = true; game.inning=1; game.top=true; game.outs=0; game.bases=[0,0,0]; game.score={a:0,h:0}; game.batIdx={a:0,h:0};
    game.counts = {s:0, b:0};
    
    genOpponent();
    
    currentPitcher = rotation.SP;
    updateBoard();
    
    // é¡¯ç¤ºæ‡‰æ´åœ˜ Buff è³‡è¨Š
    let cheerStatus = activeCheers.slice(0, 3).filter(c => c).map(c => {
        const cheerLevel = cheerMultipliers[c.name] || 1;
        return `${c.name} [Lv.${cheerLevel}]`;
    });
    
    if (activeCheers.length > 3 && activeCheers[3]) {
         cheerStatus.push(`æ¼”å”±æœƒå˜‰è³“ (${activeCheers[3].name})`);
    }

    document.getElementById('active-cheer').innerText = cheerStatus.length ? cheerStatus.join(' / ') : "ç„¡";
    document.getElementById('bullpen-display').innerText = ['RP1','RP2','CP'].map(r=> rotation[r] ? `${rotation[r].name} (é«”:${rotation[r].stamina.toFixed(0)})` : "-").join(' / ');

    document.getElementById('btn-start').disabled = true;
    document.getElementById('btn-start').innerText = "è½‰æ’­ä¸­...";
    log(">>> æ¯”è³½é–‹å§‹ <<<", "log-hl");
    
    setTimeout(playPhase, 1000);
}


function initWeatherAndField() {
    gameWeather = WEATHER_DB[Math.floor(Math.random() * WEATHER_DB.length)];
    
    let infoHTML = `
        ğŸŸï¸ å ´åœ°: <strong>${gameWeather.name}</strong> 
        | â˜€ï¸ å¤©æ°£: <span class="weather">${gameWeather.weather}</span> 
        | ğŸ’¨ é¢¨å‘: <span class="wind">${gameWeather.wind}</span>
    `;
    
    activeCheers[3] = null; 

    if (gameWeather.effect === "Dome") {
        const singerName = gameWeather.singers[Math.floor(Math.random() * gameWeather.singers.length)];
        const domeCheer = createUnit({ n: singerName, r: "Special", buff: "æ¼”å”±æœƒ" }, 'cheer');
        activeCheers[3] = domeCheer; 
        
        infoHTML += `<br>ğŸ‰ <strong>å¤§å·¨è›‹é¡å¤– Buffï¼š</strong> æ­Œæ‰‹ <span class="r-Special">${singerName}</span> æ‡‰æ´ä¸­ï¼`;
        log(`ğŸ‰ å°åŒ—å¤§å·¨è›‹é™å®šï¼æ­Œæ‰‹ <span class="r-Special">${singerName}</span> å¸¶ä¾†é¡å¤–å£«æ°£æ‡‰æ´ï¼`, "log-hl");
    } else if (gameWeather.desc) {
        infoHTML += ` (${gameWeather.desc})`;
    }

    document.getElementById('weather-info').innerHTML = infoHTML;
}

function getHandMatchup(P, B) {
    if (!P || !B) return 'Neutral';
    if (P.hand === B.hand) return 'Conflict'; 
    return 'Advantage'; 
}


function simulateAtBat() {
    game.counts = {s:0, b:0};
    const P = game.top ? currentPitcher : opponent.pitcher;
    const B = game.top ? opponent.lineup[game.batIdx.a % 9] : lineup[game.batIdx.h % 9];
    
    if (!B) {
        log(`ğŸš¨ è­¦å‘Šï¼æ‰“ç·šä¸­ç¬¬ ${game.top ? game.batIdx.a % 9 + 1 : game.batIdx.h % 9 + 1} æ£’ç©ºç¼ºï¼Œåˆ¤å‡ºå±€ã€‚`, "log-error");
        addOut();
        return; 
    }
    
    const isHomeDef = game.top;
    const myColor = 'my-team-color';
    const oppColor = 'opp-team-color';
    const P_color = isHomeDef ? myColor : oppColor;
    const B_color = isHomeDef ? oppColor : myColor;

    document.getElementById('curr-p').innerHTML = `<span class="${P_color}">${P.name} (${HAND_ZH[P.hand]})</span>`;
    document.getElementById('curr-b').innerHTML = `<span class="${B_color}">${B.name} (${HAND_ZH[B.hand]})</span>`;
    updateBoard();

    let outcome = null;

    while (!outcome) {
        
        const matchup = getHandMatchup(P, B);
        
        // --- NEW: æ‡‰ç”¨çƒå“¡ä¹˜æ•¸å’Œå•¦å•¦éšŠä¹˜æ•¸å¾Œçš„å‹•æ…‹èƒ½åŠ›å€¼ ---
        const B_con = getAdjustedStatValue(B, 'con', matchup, false);
        const P_stu = getAdjustedStatValue(P, 'stu', matchup, true);
        // ------------------------------------

        const fatiguePenalty = P.stamina < 20 ? (20 - P.stamina) * 0.5 : 0;
        
        const staDrainMultiplier = (gameWeather.weather === "ç‚ç†±") ? 1.1 : 1.0;

        let pitchDiff = B_con - P_stu - fatiguePenalty + (Math.random()*40 - 20); 

        if (P.type === 'player' && isHomeDef) {
            P.stamina = Math.max(0, P.stamina - (0.2 * staDrainMultiplier));
            updateStaBar();
        }

        if (pitchDiff > 10) {
            // --- NEW: æ‡‰ç”¨çƒå“¡ä¹˜æ•¸å’Œå•¦å•¦éšŠä¹˜æ•¸å¾Œçš„å‹•æ…‹ Power å€¼ ---
            const B_pwr = getAdjustedStatValue(B, 'pwr', matchup, false);
            // ------------------------------------
            
            let hitPowerDiff = B_pwr - P.stats.total + (Math.random()*30 - 15) + (gameWeather.bonus || 0); 
            
            if (hitPowerDiff > 20) {
                outcome = 'HR';
                log(`ğŸ”¥ <span class="${B_color}">${B.name}</span> ç‚¸è£‚ï¼å…¨å£˜æ‰“ï¼`, "log-hl");
            } else {
                outcome = 'Hit';
                handleDefense(B, isHomeDef, B_color, hitPowerDiff);
            }
            if (B.type === 'player' && !isHomeDef) B.stamina = Math.max(0, B.stamina - (0.5 * staDrainMultiplier));

        } else if (pitchDiff > -15) {
            // å·®å‹æ“Šçƒ (Foul/Miss/Out)
            if (Math.random() < 0.3 && game.counts.s < 2) {
                game.counts.s++;
                log(`âš¾ <span class="${B_color}">${B.name}</span> æ®æ£’è½ç©ºï¼Œè¨ˆå¥½çƒã€‚`);
            } else if (game.counts.s < 2) {
                game.counts.s++;
                log(`ğŸ©¹ <span class="${B_color}">${B.name}</span> æ“¦æ£’ç•Œå¤–ï¼Œè¨ˆå¥½çƒã€‚`);
                if (B.type === 'player' && !isHomeDef) B.stamina = Math.max(0, B.stamina - (0.1 * staDrainMultiplier));
            } else {
                outcome = 'Out';
                handleDefense(B, isHomeDef, B_color, -20); 
            }
        } else {
            // å£çƒ (Ball)
            game.counts.b++;
            log(`âšª æŠ•æ‰‹æŠ•å‡ºå£çƒã€‚`);
        }
        
        if (game.counts.s >= 3) {
            outcome = 'SO';
            log(`ğŸ’¨ <span class="${B_color}">${B.name}</span> é­åˆ°ä¸‰æŒ¯ï¼`, "log-out");
        } else if (game.counts.b >= 4) {
            outcome = 'BB';
            log(`ğŸš¶ <span class="${B_color}">${B.name}</span> ç²å¾—å››å£ä¿é€ï¼`, "log-out");
        }
        
        if (outcome) {
            if (outcome === 'BB') scoreRun(0);
            else if (outcome === 'HR') scoreRun(4);
            else if (outcome === 'SO' || outcome === 'Out') addOut();

            game.counts = {s:0, b:0};
            updateBoard();
            return;
        }

        updateBoard(); 
    }
}


function playPhase() { 
    if(!game.active) return;
    
    if (game.inning >= 5 && Math.abs(game.score.a - game.score.h) >= 10) {
        log(`âš ï¸ æå‰çµæŸï¼æ¯”æ•¸å·®è·éå¤§ (10åˆ†å·®)ï¼Œå•Ÿå‹•æ‰£å€’æ¢æ¬¾ã€‚`, "log-error");
        endGame();
        return;
    }

    if(game.inning>9 && game.score.a!==game.score.h) { endGame(); return; }
    if(game.inning>=9 && !game.top && game.score.h>game.score.a) { endGame(); return; }

    if (game.top) {
        checkSubstitution();
    }
    
    simulateAtBat();

    if(game.top) game.batIdx.a++; else game.batIdx.h++;
    if(game.active) setTimeout(playPhase, 2000);
}

function checkSubstitution() { 
    if (!currentPitcher || currentPitcher.stamina >= 20) return false;

    const roles = ['RP1', 'RP2', 'CP'];
    for (const role of roles) {
        let reliever = rotation[role];
        if (reliever && reliever.stamina > 40 && reliever.injury === 0 && reliever.id !== currentPitcher.id) {
            const oldPName = currentPitcher.name;
            currentPitcher = reliever;
            rotation.SP = reliever;
            
            log(`ğŸ”„ æ›æŠ•ï¼ <span class="my-team-color">${oldPName}</span> (é«”åŠ›:${currentPitcher.stamina.toFixed(0)}) é€€å ´ï¼Œç”± <span class="my-team-color">${reliever.name}</span> æ¥æ›¿ã€‚`, "log-hl");
            document.getElementById('bullpen-display').innerText = ['RP1','RP2','CP'].map(r=> rotation[r] ? `${rotation[r].name} (é«”:${rotation[r].stamina.toFixed(0)})` : "-").join(' / ');
            return true;
        }
    }
    
    if (currentPitcher.stamina < 5) {
        log(`ğŸš¨ è­¦å‘Šï¼ç‰›æ£šç„¡äººï¼Œ<span class="my-team-color">${currentPitcher.name}</span> é«”åŠ›è€—ç›¡ï¼Œè¢«è¿«çºŒæŠ•ï¼`, "log-error");
    }
    return false;
}

function handleDefense(batter, isHomeDef, B_color, hitPowerDiff) { 
    const myColor = 'my-team-color';
    const oppColor = 'opp-team-color';
    const D_color = isHomeDef ? myColor : oppColor;
    
    let locs = ["SS","3B","2B","1B","CF","RF","LF"];
    let loc = locs[Math.floor(Math.random()*locs.length)];
    let loc_zh = POS_ZH[loc] || loc;
    
    let type = ["æ»¾åœ°çƒ","å¹³é£›çƒ","é«˜é£›çƒ"][Math.floor(Math.random()*3)];
    let verb = type==="æ»¾åœ°çƒ" ? "æ»¾å‘" : type==="å¹³é£›çƒ" ? "å°„å‘" : "é£›å‘";
    
    let fielder = null;
    let defRoster = isHomeDef ? lineup : opponent.lineup;

    let f = defRoster.find(x => x && (x.pos === loc || x.pos === 'IF' && ['3B','SS','2B','1B'].includes(loc) || x.pos === 'OF' && ['LF','CF','RF'].includes(loc)));
    if (!f) f = defRoster.find(x => x && x.pos === 'SS');
    if (!f) f = defRoster.find(x => x && x.pos === 'C');
    fielder = f;

    let isHit = false;
    let baseHit = 1;
    
    let defenseModifier = (hitPowerDiff > 10) ? 1.5 : 1; 
    
    // --- NEW: æ‡‰ç”¨çƒå“¡ä¹˜æ•¸å¾Œçš„é˜²å®ˆå€¼ ---
    let defenseValue = (fielder && fielder.type === 'player') ? getAdjustedStatValue(fielder, 'def') / 100 : 0.6;
    // ----------------------------------
    
    let hitChance = 0.5 + (hitPowerDiff / 50) * defenseModifier;
    
    if (Math.random() < hitChance) {
        isHit = true;
        if (hitPowerDiff > 15) baseHit = 2;
        log(`ğŸ“¢ <span class="${B_color}">${batter.name}</span> å°‡çƒæ“Šå‘ ${loc_zh}ï¼Œå½¢æˆ${baseHit}å£˜å®‰æ‰“ï¼`, "log-hl");
    } else {
        let errorChance = 0;
        if (fielder && fielder.type === 'player') {
            // éŒ¯èª¤ç‡ï¼š(100 - é˜²å®ˆå€¼) * ä¿‚æ•¸ + (100 - é«”åŠ›) * ä¿‚æ•¸
            errorChance = (100 - getAdjustedStatValue(fielder, 'def')) * 0.4;
            errorChance += (100 - fielder.stamina) * 0.2;
            errorChance = Math.max(1, errorChance); 
        } else {
            errorChance = 10; 
        }

        if(Math.random() * 100 < errorChance) {
            log(`[E] <span class="${B_color}">${batter.name}</span> ${verb}${loc_zh}ï¼ <span class="${D_color}">${fielder.name||'é‡æ‰‹'}</span> è™•ç†å¤±èª¤ï¼`, "log-error");
            isHit = true; 
        } else {
            let fielderName = fielder ? fielder.name : "é‡æ‰‹";
            let outVerb = type==="æ»¾åœ°çƒ" ? "åˆºæ®ºå‡ºå±€" : "æ¥æ®ºå‡ºå±€";
            log(`ğŸ”´ <span class="${B_color}">${batter.name}</span> ${verb}${loc_zh}ï¼Œè¢« <span class="${D_color}">${fielderName}</span> ${outVerb}ã€‚`, "log-out");
            addOut();
        }
    }

    if (isHit) {
        scoreRun(baseHit);
    }
}
function scoreRun(n) { 
    let r = 0;
    if(n===4) { r=1+game.bases.reduce((a,b)=>a+b,0); game.bases=[0,0,0]; }
    else {
        let runners = [...game.bases]; 
        game.bases=[0,0,0];
        
        for(let i=2; i>=0; i--) {
            if(runners[i]) {
                if (i + n >= 3) { r++; }
                else { game.bases[i+n] = 1; }
            }
        }
        if (n > 0) game.bases[n-1]=1; 
        if (n === 0) {
            if (runners[0] && runners[1] && runners[2]) r++;
            else if (runners[0] && runners[1]) game.bases[2]=1; 
            else if (runners[0]) game.bases[1]=1; 
            game.bases[0] = 1;
        }
        game.bases = game.bases.map(b => b > 1 ? 1 : b); 
    }
    
    if(r>0) {
        if(game.top) game.score.a+=r; else game.score.h+=r;
        log(`>>> å¾— ${r} åˆ†`, "log-score");
    }
    updateBoard();
}
function addOut() { 
    game.outs++;
    if(game.outs>=3) {
        log("--- æ›å±€ ---");
        game.outs=0; game.bases=[0,0,0];
        if(game.top) game.top=false; else { 
            game.top=true; game.inning++; 
            if (rotation.SP !== currentPitcher) rotation.SP = currentPitcher;
        }
        // æ¸…é™¤å¤§å·¨è›‹è‡¨æ™‚å•¦å•¦éšŠ
        if(gameWeather.effect === "Dome") activeCheers[3] = null;
    }
    updateBoard();
}
function updateStaBar() { 
    if (!currentPitcher) return;
    let p = currentPitcher;
    let bar = document.getElementById('my-pitcher-sta').children[0];
    bar.style.width = p.stamina + "%";
    bar.style.background = p.stamina>50?"#4caf50":"#f44336";
}
function updateBoard() { 
    document.getElementById('score-a').innerText = game.score.a;
    document.getElementById('score-h').innerText = game.score.h;
    document.getElementById('inning-txt').innerText = `${game.inning}${game.top?'ä¸Š':'ä¸‹'}`;
    document.getElementById('cnt-o').innerText = game.outs;
    document.getElementById('cnt-s').innerText = game.counts.s;
    document.getElementById('cnt-b').innerText = game.counts.b;
    
    ['1','2','3'].forEach((k,i)=> {
        const baseElement = document.getElementById(`base-${k}`);
        if (game.bases[i]) {
            baseElement.classList.add('active');
        } else {
            baseElement.classList.remove('active');
        }
    });

    let current_status_html = "--- ä¼‘æ¯ä¸­ ---";
    if (game.active) {
        const P = game.top ? currentPitcher : opponent.pitcher;
        const B = game.top ? opponent.lineup[game.batIdx.a % 9] : lineup[game.batIdx.h % 9];
        
        const P_hand = P ? HAND_ZH[P.hand] : 'N/A';
        const B_hand = B ? HAND_ZH[B.hand] : 'N/A';

        if (game.top) {
            current_status_html = `å®ˆå‚™æŠ•æ‰‹: <span class="my-team-color">${P ? P.name : 'N/A'} (${P_hand})</span> (é«”:${P ? P.stamina.toFixed(0) : 'N/A'}) / å°æ‰‹æ‰“è€…: <span class="opp-team-color">${B.name} (${B_hand})</span>`;
        } else {
            current_status_html = `æˆ‘æ–¹æ‰“è€…: <span class="my-team-color">${B.name} (${B_hand})</span> (é«”:${B.stamina.toFixed(0)}) / å°æ‰‹æŠ•æ‰‹: <span class="opp-team-color">${P.name} (${P_hand})</span>`;
        }
    }
    document.getElementById('my-current-action').innerHTML = current_status_html;
    updateStaBar();
}

function endGame() { 
    game.active = false;
    let win = game.score.h > game.score.a;
    let rwd = win ? 2000 : 500;
    
    if(opponent.name === OVERSEAS_ALLSTARS.name) {
        rwd = win ? 5000 : 1000;
        log(`ğŸ† æ“Šæ•— <span class='log-hl'>${OVERSEAS_ALLSTARS.name}</span>ï¼é¡å¤–çå‹µï¼`, "log-hl");
    }
    
    money += rwd; updateMoney();
    log(`ğŸ æ¯”è³½çµæŸï¼ ${win?'ç²å‹':'è½æ•—'}ï¼Œç²å¾— $${rwd}`, "log-hl");
    
    let healBuff = activeCheers.filter(c=>c).some(c=>c.buff==="å…¨èƒ½"||c.buff==="é«”åŠ›"||c.buff==="æ¼”å”±æœƒ"); 
    
    myRoster.forEach(u => {
        if(u.type === 'cheer') return;
        
        const usedIDs = getUsedIDs();
        // å¤§å·¨è›‹å•¦å•¦éšŠ ID æœƒåœ¨ usedIDs è£¡ï¼Œä¸ç”¨é¡å¤–åŠ 

        const played = usedIDs.has(u.id); // æª¢æŸ¥å¡ç‰‡ ID æ˜¯å¦è¢«ä½¿ç”¨
        
        if(played) {
            let drain = u.pos==='P' ? 20 : 5;
            if (gameWeather.weather === "ç‚ç†±") drain *= 1.1; 
            if(healBuff) drain *= getCheerMultiplier(); // é«”åŠ› Buff ä¹Ÿæ‡‰ç”¨ä¹˜æ•¸
            u.stamina = Math.max(0, u.stamina - drain);
            
            if(u.stamina < 30) {
                let risk = (30 - u.stamina) * 0.02; 
                if(healBuff) risk *= 0.5;
                if(Math.random() < risk) {
                    u.injury = Math.floor(Math.random()*3) + 3; 
                    log(`ğŸ¥ <span class="my-team-color">${u.name}</span> å› éå‹å—å‚·ï¼éœ€ä¼‘é¤Š ${u.injury} å ´`, "log-inj");
                    
                    // å—å‚·å¾Œå¾é™£å®¹/è¼ªå€¼ä¸­ç§»é™¤ (æŒ‰ ID ç§»é™¤)
                    lineup = lineup.map(p => p && p.id === u.id ? null : p);
                    for(let r in rotation) { if(rotation[r] && rotation[r].id === u.id) rotation[r] = null; }
                }
            }
        } else {
            if(u.injury > 0) {
                u.injury--;
                if(u.injury === 0) {
                    u.stamina = 60; 
                    log(`âœ¨ <span class="my-team-color">${u.name}</span> å‚·ç™’æ­¸éšŠï¼`);
                }
            } else {
                u.stamina = Math.min(100, u.stamina + 15);
            }
        }
    });

    activeCheers[3] = null; 

    document.getElementById('btn-start').disabled = false;
    document.getElementById('btn-start').innerText = "ğŸ“¡ ä¸‹ä¸€å ´æ¯”è³½";
    renderUI(); 
}

function log(msg, cls) { 
    let d = document.createElement('div'); d.className=cls; d.innerHTML=msg;
    let b = document.getElementById('play-log'); b.appendChild(d); b.scrollTop=b.scrollHeight;
}
function updateMoney() { document.getElementById('money-val').innerText = `$${money.toLocaleString()}`; }
function setTab(t) { 
    ['roster','game','scout'].forEach(x=>document.getElementById(`tab-${x}`).style.display='none');
    document.getElementById(`tab-${t}`).style.display='block';
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector(`.nav-btn[onclick="setTab('${t}')"]`).classList.add('active');
    
    if (t === 'roster') {
        renderUI();
    }
}
function getPlayerAvgRating() { 
    const activePlayers = [...lineup.filter(p => p), ...Object.values(rotation).filter(p => p)];
    if (activePlayers.length === 0) return 70; 
    const total = activePlayers.reduce((sum, p) => sum + getFinalPlayerStat(p, 'total'), 0);
    return total / activePlayers.length;
}
function adjustBaseStats(targetAvg, baseStats) { 
    const ratingDiff = targetAvg - 70; 
    const adjustment = Math.floor(ratingDiff / 10) * 5; 
    const newBase = baseStats + adjustment;
    return Math.max(65, Math.min(105, newBase)); 
}
function genOpponent() { 
    let oppData;
    let myAvgRating = getPlayerAvgRating();

    if (Math.random() < 0.05) { 
        oppData = OVERSEAS_ALLSTARS;
        log("ğŸ“¢ é­é‡ <span class='log-hl'>ã€å°ç£æ—…å¤–æ€ªç‰©éšŠã€‘</span>ï¼é€™å°‡æ˜¯ä¸€å ´ç¡¬æˆ°ï¼", "log-hl");
    } else {
        let keys = Object.keys(TEAMS); 
        let teamKey = keys[Math.floor(Math.random()*keys.length)];
        oppData = TEAMS[teamKey];
    }
    
    document.getElementById('opp-name').innerText = oppData.name;
    
    let targetOppRating = myAvgRating * 1.01 + (Math.random() * 2); 
    let oppBase = Math.floor(Math.max(75, Math.min(100, targetOppRating))); 
    
    if (oppData.name === OVERSEAS_ALLSTARS.name) {
        oppBase = Math.max(90, oppBase); 
    }

    opponent.lineup = [];
    const usedNames = new Set();
    const posPriorities = ["CF","SS","1B","DH","3B","LF","C","RF","2B"];
    
    for (const pos of posPriorities) {
        let nameCounter = 1;
        let playerTemplate = oppData.roster.find(x => x.p === pos);

        while((!playerTemplate || usedNames.has(playerTemplate.n)) && nameCounter < 20) {
            const allPlayers = Object.values(TEAMS).flatMap(t => t.roster).concat(OVERSEAS_ALLSTARS.roster);
            const posCandidates = allPlayers.filter(p => p.p === pos && !usedNames.has(p.n));
            
            if (posCandidates.length > 0) {
                playerTemplate = posCandidates[Math.floor(Math.random() * posCandidates.length)];
            } else {
                playerTemplate = {n: `${oppData.name} ${pos}æ‰‹ ${nameCounter++}`, p: pos, r: 'R'};
                break;
            }
        }
        
        usedNames.add(playerTemplate.n);

        let player = createUnit(playerTemplate);
        
        player.stats = generateDynamicStats(oppBase, player.pos);
        
        opponent.lineup.push(player);
        if (opponent.lineup.length >= 9) break; 
    }
    
    let spTemplate = oppData.roster.find(x=>x.p==='P');
    
    if (!spTemplate || usedNames.has(spTemplate.n)) {
        const allPitchers = Object.values(TEAMS).flatMap(t => t.roster).concat(OVERSEAS_ALLSTARS.roster).filter(p => p.p === 'P' && !usedNames.has(p.n));
        spTemplate = allPitchers.length > 0 ? allPitchers[Math.floor(Math.random() * allPitchers.length)] : {n:"ç‹ç‰ŒæŠ•æ‰‹",r:"SR",p:'P'};
    }

    opponent.pitcher = createUnit(spTemplate);
    opponent.pitcher.stats = generateDynamicStats(oppBase, opponent.pitcher.pos);
    
    document.getElementById('opp-sp').innerText = `${opponent.pitcher.name} (${HAND_ZH[opponent.pitcher.hand]} / è©•:${opponent.pitcher.stats.total})`;
    document.getElementById('opp-lineup-list').innerHTML = opponent.lineup.map((p,i)=>`<li>${i+1}.${p.name} (${POS_ZH[p.pos]||p.pos} / ${HAND_ZH[p.hand]}) (è©•:${p.stats.total})</li>`).join('');
}
function generateDynamicStats(targetAvg, pos) { 
    const rand = () => Math.floor(Math.random() * 8) - 4; 
    
    let stats = { con: 0, pwr: 0, spd: 0, def: 0, stu: 0, total: 0, multiplier: 1.0 };
    let baseValue = adjustBaseStats(targetAvg, 70); 

    if (pos === 'P') {
        stats.stu = baseValue + rand() + 5; 
        stats.con = baseValue + rand() - 5;
        stats.pwr = baseValue + rand() - 5;
        stats.spd = baseValue + rand();
        stats.def = baseValue + rand();
    } else if (['SS', 'CF'].includes(pos)) {
        stats.def = baseValue + rand() + 5; 
        stats.spd = baseValue + rand() + 5;
        stats.con = baseValue + rand();
        stats.pwr = baseValue + rand() - 5;
        stats.stu = baseValue + rand() - 5;
    } else { 
        stats.con = baseValue + rand() + 5;
        stats.pwr = baseValue + rand();
        stats.def = baseValue + rand();
        stats.spd = baseValue + rand();
        stats.stu = baseValue + rand() - 5;
    }

    for(let key in stats) {
        if (key !== 'total' && key !== 'multiplier') {
            stats[key] = Math.max(60, Math.min(105, stats[key]));
        }
    }
    
    stats.total = Math.floor((stats.con + stats.pwr + stats.spd + stats.def) / 4);

    return stats;
}
function drawSingle() { 
    let rnd = Math.random()*100;
    let data;
    let type = 'player';
    let r = "N";

    if(rnd < 20) {
        let c = CHEER_DB[Math.floor(Math.random()*CHEER_DB.length)]; 
        data = c; 
        type = 'cheer';
        r = c.r;
    } else {
        if(rnd < 25) r = "SSR"; else if(rnd < 40) r = "SR"; else if(rnd < 60) r = "R";
        
        let pool = []; 
        const highRarityPool = [...HISTORY, ...OVERSEAS_ALLSTARS.roster];
        
        if(r==="SSR" || r==="SR") {
             pool = highRarityPool.filter(x=>x.r===r);
             if(pool.length === 0) pool = TEAMS.brothers.roster.filter(x=>x.r===r);
        }
        if(pool.length===0) pool = TEAMS.brothers.roster.filter(x=>x.r==='R');
        if(pool.length===0) pool = [{n:"æ½›åŠ›æ–°ç§€",p:'P',r:'N'}, {n:"æ½›åŠ›æ–°ç§€",p:'IF',r:'N'}]; 

        data = pool[Math.floor(Math.random()*pool.length)];
        data = {...data, y: 1990 + Math.floor(Math.random()*35)};
    }
    
    const unit = createUnit(data, type);
    unit.rarity = r; 
    
    if (unit.type === 'player') {
        // ç¢ºä¿æ–°å¡ç‰‡æœ‰åŸºç¤ä¹˜æ•¸
        unit.stats = genStats(r);
        unit.stats.multiplier = 1.0; 
    }

    return unit;
}
function gacha() { 
    if(money < 1000) { alert("è³‡é‡‘ä¸è¶³ï¼å–®æŠ½éœ€è¦ $1,000"); return; }
    money -= 1000; updateMoney();

    const unit = drawSingle();
    myRoster.push(unit);
    renderUI();

    renderGachaResult([unit]);
}
function gachaTen() { 
    if(money < 10000) { alert("è³‡é‡‘ä¸è¶³ï¼åé€£æŠ½éœ€è¦ $10,000"); return; }
    money -= 10000; updateMoney();

    const results = [];
    let hasSSR = false;
    let lowestRarityIndex = -1;
    let lowestRarityValue = 99; 

    for (let i = 0; i < 10; i++) {
        let unit = drawSingle();
        results.push(unit);
        myRoster.push(unit);
        
        if (unit.rarity === 'SSR') {
            hasSSR = true;
        }

        const rarityValue = RARITY_ORDER[unit.rarity] || 0;
        if (unit.type === 'player' && rarityValue < lowestRarityValue) {
            lowestRarityValue = rarityValue;
            lowestRarityIndex = i;
        }
    }

    if (!hasSSR && lowestRarityIndex !== -1) {
        let fallbackUnit = results[lowestRarityIndex];
        
        if (fallbackUnit.type === 'player') {
            fallbackUnit.rarity = 'SSR';
            fallbackUnit.stats = genStats('SSR'); 
            fallbackUnit.stats.multiplier = 1.0; 
            fallbackUnit.stats.total = getFinalPlayerStat(fallbackUnit, 'total');
        }
    }

    renderUI();
    renderGachaResult(results);
}
function renderGachaResult(results) { 
    const box = document.getElementById('gacha-result');
    box.innerHTML = results.map(unit => {
        const cls = unit.type === 'cheer' ? "Cheer" : unit.rarity;
        const nameDisplay = unit.name.length > 4 ? unit.name.substring(0, 4) + '..' : unit.name;
        
        let subText;
        if (unit.type === 'cheer') {
            const cheerLevel = cheerMultipliers[unit.name] || 1;
            subText = `ğŸ“£ Lv.${cheerLevel}`;
        } else {
            subText = `âš¾ ${POS_ZH[unit.pos] || unit.pos}`;
        }

        return `
            <div class="gacha-card ${cls}">
                <div style="font-weight:bold;">${unit.rarity}</div>
                <div style="margin:2px 0; font-weight: bold; overflow: hidden; white-space: nowrap;">${nameDisplay}</div>
                <div style="font-size:0.7rem;">${subText}</div>
            </div>
        `;
    }).join('');
}


init();
</script>
</body>
</html>
