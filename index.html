<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>CPBL 2025 çµ‚æ¥µç¶“ç†äººï¼šç„¡é™æ‡‰æ´ç‰ˆ (V2)</title>
    <style>
        :root { 
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --primary: #1565c0; --accent: #ff4081; --gold: #ffd700; 
            --my-team-color: #90caf9; /* è—è‰² */
            --opp-team-color: #ffcc80; /* æ©˜è‰² */
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* ç¨€æœ‰åº¦ */
        .r-SSR { color: var(--gold); text-shadow: 0 0 8px rgba(255, 215, 0, 0.6); font-weight: bold; }
        .r-SR { color: #e0e0e0; text-shadow: 0 0 5px rgba(255, 255, 255, 0.4); font-weight: bold; }
        .r-R { color: #42a5f5; font-weight: bold; }
        .r-N { color: #9e9e9e; }
        .r-Special { color: #ff5252; font-weight: bold; } /* æ¼”å”±æœƒå˜‰è³“ */
        .injured { color: #ff5252; text-decoration: line-through; opacity: 0.7; }

        /* å¸ƒå±€ */
        .screen { display: none; height: 100%; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .screen.active { display: block; }
        
        /* é¸éšŠ */
        #screen-select { text-align: center; background: radial-gradient(circle, #1a237e 0%, #000 90%); }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; max-width: 1000px; margin: 40px auto; }
        .team-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; cursor: pointer; border: 1px solid #444; transition: 0.3s; }
        .team-card:hover { border-color: var(--gold); transform: translateY(-5px); background: rgba(255,255,255,0.15); }
        .team-logo { font-size: 3rem; display: block; margin-bottom: 5px; }

        /* Header */
        header { height: 55px; background: #0d47a1; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 3px solid var(--gold); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .nav-btn { background: transparent; border: none; color: #bbb; font-weight: bold; cursor: pointer; padding: 0 15px; height: 100%; font-size: 1rem; }
        .nav-btn.active { color: #fff; border-bottom: 4px solid #fff; background: rgba(255,255,255,0.1); }
        .money-badge { background: linear-gradient(45deg, #ffb300, #f57f17); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: bold; }

        /* é¢æ¿ */
        .panel { background: var(--card); border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
        h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 5px; color: var(--my-team-color); font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 6px; text-align: left; border-bottom: 1px solid #333; }
        select { width: 100%; background: #2c2c2c; color: #fff; border: 1px solid #555; padding: 5px; border-radius: 4px; }
        option:disabled { color: #ff5252; background: #222; }

        /* é«”åŠ›æ¢ */
        .sta-bar-bg { width: 50px; height: 6px; background: #444; display: inline-block; border-radius: 3px; }
        .sta-bar-fill { height: 100%; border-radius: 3px; }

        /* å•¦å•¦éšŠæ¸…å–® */
        .cheer-item { background: #333; padding: 5px 8px; border-radius: 4px; font-size: 0.8rem; border-left: 3px solid var(--accent); }

        /* æ¯”è³½å€ */
        .game-layout { display: grid; grid-template-columns: 260px 1fr 260px; gap: 15px; height: calc(100vh - 120px); }
        @media(max-width: 900px) { .game-layout { grid-template-columns: 1fr; } }
        
        #play-log { height: 220px; overflow-y: auto; background: #111; padding: 10px; font-family: monospace; font-size: 0.9rem; line-height: 1.5; border: 1px solid #444; }
        .log-hl { color: var(--gold); } .log-out { color: #90a4ae; } .log-score { color: #69f0ae; font-weight: bold; }
        .log-inj { color: #ff5252; font-weight: bold; background: rgba(255,0,0,0.1); padding: 2px; }
        .log-error { color: #ffa000; font-weight: bold; }

        /* éšŠä¼é¡è‰² */
        .my-team-color { color: var(--my-team-color); }
        .opp-team-color { color: var(--opp-team-color); }

        /* å£˜åŒ…å‹•æ…‹ */
        .base { transition: background 0.2s, box-shadow 0.2s; }
        .base.active { background: #ff4081 !important; border-color: #f06292 !important; box-shadow: 0 0 10px #ff4081; }

        /* å ´åœ°è³‡è¨Š */
        #weather-info { background: #333; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 0.9rem; }
        .wind { color: #81c784; } .weather { color: #fff176; }

        /* æ‹›å‹Ÿå€å¡Š */
        .gacha-buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .btn-gacha { padding: 10px 20px; font-size: 1.1rem; font-weight: bold; border-radius: 6px; cursor: pointer; transition: background 0.3s; }
        .btn-single { background: #03a9f4; color: white; border: none; }
        .btn-ten { background: var(--gold); color: #000; border: 2px solid #fff; } /* ç¢ºä¿æ–‡å­—é¡è‰²æ˜¯é»‘è‰² #000 */

        .gacha-box { 
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; 
            max-height: 250px; overflow-y: auto; padding: 10px; 
        }
        .gacha-card { 
            width: 80px; text-align: center; padding: 5px; border-radius: 4px; 
            background: #2e7d32; /* Default */
            border: 1px solid #4caf50;
            font-size: 0.8rem;
        }
        .SSR { background: #ffd700; color: #111; border-color: #fff; }
        .SR { background: #e0e0e0; color: #111; border-color: #9e9e9e; }
        .R { background: #42a5f5; color: white; border-color: #1565c0; }
        .N { background: #9e9e9e; color: #111; border-color: #757575; }
        .Cheer { background: var(--accent); color: white; border-color: #f8bbd0; }
    </style>
</head>
<body>

<div id="screen-select" class="screen active">
    <h1 style="color: white; margin-top: 50px;">CPBL 2025 çµ‚æ¥µç¶“ç†äºº (V2)</h1>
    <p style="color: #aaa;">è«‹é¸æ“‡çƒéšŠ (åŒ…å«åˆå§‹çƒå“¡ã€è³‡é‡‘ $1,000,000 èˆ‡å°ˆå±¬å•¦å•¦éšŠ)</p>
    <div class="team-grid" id="team-list"></div>
</div>

<div id="screen-main" class="screen">
    <header>
        <div style="font-weight: bold;">âš¾ ç„¡é™æ‡‰æ´ç‰ˆ (V2)</div>
        <nav style="height: 100%;">
            <button class="nav-btn active" onclick="setTab('roster')">é™£å®¹ç®¡ç†</button>
            <button class="nav-btn" onclick="setTab('game')">æ¯”è³½è½‰æ’­</button>
            <button class="nav-btn" onclick="setTab('scout')">çƒå“¡æ‹›å‹Ÿ</button>
        </nav>
        <div class="money-badge" id="money-val">$1,000,000</div>
    </header>

    <div id="tab-roster" style="margin-top: 15px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 300px; gap: 15px;">
            <div class="panel">
                <h3>ğŸ“‹ å…ˆç™¼æ‰“ç·š <button onclick="autoLineup()" style="font-size:0.8rem;">ä¸€éµæœ€ä½³åŒ–</button></h3>
                <table id="lineup-table">
                    <thead><tr><th>æ£’æ¬¡</th><th>çƒå“¡é¸æ“‡ (æ•¸å€¼/é«”åŠ›/æ…£ç”¨æ‰‹)</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="panel">
                <h3>âš¾ æŠ•æ‰‹è¼ªå€¼</h3>
                <table id="rotation-table">
                    <thead><tr><th>è§’è‰²</th><th>çƒå“¡é¸æ“‡ (æ•¸å€¼/é«”åŠ›/æ…£ç”¨æ‰‹)</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="panel" style="border-color: var(--accent);">
                <h3>ğŸ“£ æ‡‰æ´åœ˜ (Buff)</h3>
                <p style="font-size:0.8rem; color:#aaa;">æå‡å£«æ°£ï¼Œæ¸›å°‘å—å‚·ç‡</p>
                <div id="cheer-slots"></div>
            </div>

            <div class="panel" style="grid-column: span 3;">
                <h3>ğŸ“£ æ‰€æœ‰å•¦å•¦éšŠæ¸…å–® (å…± <span id="cheer-count">0</span> äºº)</h3>
                <div id="cheer-roster-view" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 120px; overflow-y: auto;"></div>
            </div>
            
            <div class="panel" style="grid-column: span 3;">
                <h3>ğŸ¥ çƒå“¡ç‹€æ…‹ç›£æ§ (ç¸½æ•¸: <span id="roster-count">0</span>)</h3>
                <p style="font-size:0.8rem; color:#aaa;">* é«”åŠ›éä½ (&lt;30) å®¹æ˜“å—å‚·ï¼Œå—å‚·éœ€ä¼‘é¤Š 3-5 å ´ã€‚ä½é«”åŠ›å®ˆå‚™å“¡æ˜“å¤±èª¤ã€‚</p>
                <div id="roster-view" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 160px; overflow-y: auto;"></div>
            </div>
        </div>
        
        <div class="panel" style="margin-top: 15px;">
            <h3>ğŸ”® åˆæˆé€²åŒ–ä¸­å¿ƒ (10 å¼µå¡ç‰‡åˆæˆ +1 é»èƒ½åŠ›)</h3>
            <div id="fusion-center">
                <p style="color:#aaa; font-style:italic;">ç›®å‰æ²’æœ‰è¶³å¤ çš„é‡è¤‡çƒå“¡å¯ä»¥åˆæˆã€‚</p>
            </div>
        </div>

    </div>

    <div id="tab-game" style="display: none; margin-top: 15px;">
        <div class="game-layout">
            <div class="panel">
                <h3>ğŸ†š å°æ‰‹ (<span id="opp-name">---</span>)</h3>
                <div style="margin-bottom:10px; padding:8px; background:#263238; border-left:3px solid #ef5350;">
                    <div style="font-size:0.8rem; color:#aaa;">å…ˆç™¼æŠ•æ‰‹</div>
                    <div id="opp-sp" style="font-weight:bold;">---</div>
                </div>
                <div style="font-size:0.85rem; color:#bbb;">å…ˆç™¼æ‰“ç·šï¼š</div>
                <ul id="opp-lineup-list" style="padding-left:20px; font-size:0.8rem; color:#aaa;"></ul>
            </div>

            <div class="panel">
                <div id="weather-info"></div>

                <div style="display: grid; grid-template-columns: 1fr 80px 1fr; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; background: #000;">
                    <div style="font-size: 2.5rem; font-weight: bold; text-align: center; color:var(--opp-team-color)" id="score-a">0</div>
                    <div style="text-align:center;">
                        <div id="inning-txt" style="color:var(--gold); font-weight:bold; font-size:1.2rem;">1å±€ä¸Š</div>
                        <div style="font-size:0.8rem; color:#ef5350;">LIVE</div>
                    </div>
                    <div style="font-size: 2.5rem; font-weight: bold; text-align: center; color:var(--my-team-color)" id="score-h">0</div>
                </div>

                <div style="background: #2e7d32; height: 180px; position: relative; border: 3px solid #1b5e20; border-radius: 8px; margin-bottom: 10px; overflow: hidden;">
                    <div class="base b1" id="base-1" style="position: absolute; width: 20px; height: 20px; transform: rotate(45deg); right: 28%; top: 50%; background: rgba(255,255,255,0.8); border: 2px solid #aaa;"></div>
                    <div class="base b2" id="base-2" style="position: absolute; width: 20px; height: 20px; transform: rotate(45deg); left: 50%; top: 20%; margin-left: -10px; background: rgba(255,255,255,0.8); border: 2px solid #aaa;"></div>
                    <div class="base b3" id="base-3" style="position: absolute; width: 20px; height: 20px; transform: rotate(45deg); left: 28%; top: 50%; background: rgba(255,255,255,0.8); border: 2px solid #aaa;"></div>
                    <div style="position:absolute; bottom:5px; right:5px; font-family:monospace; background:rgba(0,0,0,0.7); padding:3px; border-radius:3px; font-size:0.8rem;">
                        S:<span id="cnt-s">0</span> B:<span id="cnt-b">0</span> O:<span id="cnt-o">0</span>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-between; background:#333; padding:5px; border-radius:5px; font-size:0.85rem; margin-bottom:5px;">
                    <span>æŠ•: <strong id="curr-p" style="color:white">---</strong></span>
                    <span>æ‰“: <strong id="curr-b" style="color:white">---</strong></span>
                </div>

                <div id="play-log">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹æ¯”è³½...</div>
                <button class="btn btn-play" id="btn-start" onclick="startGame()">ğŸ“¡ é–‹å§‹æ¯”è³½ (æ¶ˆè€—é«”åŠ›)</button>
            </div>

            <div class="panel">
                <h3>ğŸ  æˆ‘æ–¹ç‹€æ…‹</h3>
                <div style="margin-bottom:10px;">
                    <div style="font-size:0.85rem; color:#aaa;">ç•¶å‰é€²æ”»/å®ˆå‚™çƒå“¡:</div>
                    <div id="my-current-action" style="font-weight:bold; color:white;">---</div>
                </div>
                
                <div style="font-size:0.85rem; margin-bottom:5px;">ç›®å‰æˆ‘æ–¹æŠ•æ‰‹é«”åŠ›ï¼š</div>
                <div id="my-pitcher-sta" style="height:10px; background:#444; border-radius:5px; overflow:hidden; margin-bottom:15px;">
                    <div style="width:100%; height:100%; background:#4caf50;"></div>
                </div>
                <div style="font-size:0.85rem; color:#aaa;">ç‰›æ£šå¾…å‘½ï¼š</div>
                <div id="bullpen-display" style="font-size:0.8rem;"></div>
                <hr style="border-color:#444; margin:10px 0;">
                <div style="font-size:0.85rem; color:var(--accent);">ğŸ“£ æ‡‰æ´ä¸­ï¼š</div>
                <div id="active-cheer" style="font-size:0.8rem;"></div>
            </div>
        </div>
    </div>

    <div id="tab-scout" style="display: none; margin-top: 15px;">
        <div class="panel" style="max-width: 600px; margin: 0 auto; text-align: center;">
            <h3>ğŸ’ ç¶œåˆçƒæ¢ä¸­å¿ƒ</h3>
            <p style="color:#aaa; font-size:0.9rem;">
                åŒ…å«ï¼šæ­·å²åå°‡(SSR)ã€ç¾å½¹çƒæ˜Ÿã€<b>è·¨ç•Œå•¦å•¦éšŠ(ç±ƒçƒ/æ£’çƒ/æ¼”è—)</b><br>
                <span style="color:var(--accent)">â˜… å•¦å•¦éšŠå°ˆå±¬æ•ˆæœï¼šæ¢å¾©é«”åŠ›ã€æ¸›å°‘å—å‚·</span>
            </p>
            <div class="gacha-buttons">
                <button class="btn btn-gacha btn-single" onclick="gacha()">âœ¨ å–®æŠ½ $1000</button>
                <button class="btn btn-gacha btn-ten" onclick="gachaTen()">ğŸŒŸ åé€£æŠ½ $10000 (ä¿åº• SSR)</button>
            </div>
            <div class="gacha-box" id="gacha-result"></div>
        </div>
    </div>
</div>

<script>
// ================= 1. é¾å¤§è³‡æ–™åº«èˆ‡ä¸­æ–‡åŒ– =================

const POS_ZH = {
    'P': 'æŠ•æ‰‹', 'C': 'æ•æ‰‹', '1B': 'ä¸€å£˜æ‰‹', '2B': 'äºŒå£˜æ‰‹', '3B': 'ä¸‰å£˜æ‰‹',
    'SS': 'æ¸¸æ“Šæ‰‹', 'LF': 'å·¦å¤–é‡', 'CF': 'ä¸­å¤–é‡', 'RF': 'å³å¤–é‡', 'DH': 'æŒ‡å®šæ‰“æ“Š',
    'IF': 'å…§é‡æ‰‹', 'OF': 'å¤–é‡æ‰‹' // å¢åŠ äºŒè»ç”¨èª
};
const HAND_ZH = { 'R': 'å³', 'L': 'å·¦' };

const RARITY_ORDER = { 'SSR': 4, 'SR': 3, 'R': 2, 'N': 1, 'Cheer': 0 }; // ç”¨æ–¼ä¿åº•æ™‚æ¯”è¼ƒç¨€æœ‰åº¦

// ç¨€æœ‰åº¦èƒ½åŠ›èª¿æ•´ä¸Šä¸‹é™ (Multiplier)
const RARITY_ADJUSTMENTS = {
    'SSR': { min: 0.97, max: 1.03 }, // -3% ~ +3%
    'SR':  { min: 0.95, max: 1.01 }, // -5% ~ +1%
    'R':   { min: 0.92, max: 1.00 }, // -8% ~ +0%
    'N':   { min: 0.85, max: 1.00 }, // -15% ~ +0%
    'Cheer': { min: 1.0, max: 1.0 },
    'Special': { min: 1.0, max: 1.0 }
};

// å°ç£ä¸»è¦çƒå ´èˆ‡å¤©æ°£æ•¸æ“š
const WEATHER_DB = [
    { 
        name: "è‡ºåŒ—å¤§å·¨è›‹", 
        effect: "Dome", 
        weather: "æ™´æœ— (å®¤å…§)", 
        wind: "ç„¡é¢¨", 
        bonus: 0, 
        singers: ["å‘¨æ°å€«", "å¼µæƒ å¦¹", "äº”æœˆå¤©", "è”¡ä¾æ—", "è•­æ•¬é¨°"] 
    },
    { 
        name: "è‡ºä¸­æ´²éš›æ£’çƒå ´", 
        effect: "Normal", 
        weather: "æ™´æœ—", 
        wind: "å¹å‘å¤–é‡", 
        bonus: 3, 
        desc: "è¼•å¾®é †é¢¨ï¼Œæœ‰åˆ©é•·æ‰“" 
    },
    { 
        name: "æ–°èŠæ£’çƒå ´", 
        effect: "Normal", 
        weather: "å¤šé›²", 
        wind: "å¹å‘å…§é‡", 
        bonus: -2, 
        desc: "è¼•å¾®é€†é¢¨ï¼Œç•¥ç‚ºæŠ‘åˆ¶é•·æ‰“" 
    },
    { 
        name: "æ¾„æ¸…æ¹–æ£’çƒå ´", 
        effect: "Normal", 
        weather: "ç‚ç†±", 
        wind: "ç„¡é¢¨", 
        bonus: 0, 
        desc: "å¤©æ°£ç‚ç†±ï¼Œé›™æ–¹é«”åŠ›æ¶ˆè€—åŠ å¿« 10%" 
    },
    { 
        name: "è‡ºå—æ£’çƒå ´", 
        effect: "Normal", 
        weather: "é™°å¤©", 
        wind: "å¹å‘å¤–é‡", 
        bonus: 2, 
        desc: "è¼•å¾®é †é¢¨" 
    },
];

const CHEER_DB = [
    {n:"æ—è¥„",t:"Dragons",r:"SSR",buff:"æ‰“æ“Š"}, {n:"æå¤šæ…§",t:"Dragons",r:"SSR",buff:"é€Ÿåº¦"},
    {n:"å³®å³®",t:"Brothers",r:"SSR",buff:"é˜²å®ˆ"}, {n:"çŸ­ä»Š",t:"Brothers",r:"SR",buff:"é«”åŠ›"},
    {n:"Yuri",t:"Lions",r:"SSR",buff:"æ‰“æ“Š"}, {n:"ç‘Ÿä¸ƒ",t:"Lions",r:"SR",buff:"é«”åŠ›"},
    {n:"æ…ˆå¦¹",t:"Guardians",r:"SR",buff:"é€Ÿåº¦"}, {n:"ä¸¹ä¸¹",t:"Guardians",r:"SR",buff:"é˜²å®ˆ"},
    {n:"ç±ƒç±ƒ",t:"Monkeys",r:"SSR",buff:"å…¨èƒ½"}, {n:"ç³å¦²",t:"Monkeys",r:"SR",buff:"æ‰“æ“Š"},
    {n:"ä¸€ç²’",t:"Hawks",r:"SR",buff:"é€Ÿåº¦"}, {n:"å®‰èŠå„‡",t:"Hawks",r:"SSR",buff:"å…¨èƒ½"},
    {n:"æ¢“æ¢“",t:"Formosa Sexy",r:"SSR",buff:"é˜²å®ˆ"}, {n:"å£¯å£¯",t:"Formosa Sexy",r:"SR",buff:"é«”åŠ›"},
    {n:"Mina",t:"Taishin Wonders",r:"SR",buff:"é€Ÿåº¦"}, {n:"Faye",t:"Pilots Crew",r:"SR",buff:"æ‰“æ“Š"}
];

const TEAMS = {
    "brothers": { name: "ä¸­ä¿¡å…„å¼Ÿ", logo: "ğŸ˜", cheers:["å³®å³®","çŸ­ä»Š","æ³¢æ³¢"], roster: [
        {n:"å¾·ä¿æ‹‰",p:"P",r:"SSR"}, {n:"çŒ›ç™»",p:"P",r:"SR"}, {n:"æ±Ÿå¤å®‡",p:"SS",r:"SSR"}, {n:"ç‹å¨æ™¨",p:"3B",r:"SR"}, {n:"é™³ä¿Šç§€",p:"1B",r:"SR"}, {n:"å²³æ±è¯",p:"2B",r:"R"}, {n:"æ›¾é Œæ©",p:"RF",r:"SR"}, {n:"å²³æ”¿è¯",p:"CF",r:"R"}, {n:"é«˜å®‡æ°",p:"C",r:"R"}, {n:"è©¹å­è³¢",p:"LF",r:"R"}
    ]},
    "lions": { name: "çµ±ä¸€ç…", logo: "ğŸ¦", cheers:["Yuri","ç‘Ÿä¸ƒ","è‰¾ç’"], roster: [
        {n:"å‹é¨å£«",p:"P",r:"SSR"}, {n:"å¤æ—ç¿ç…¬",p:"P",r:"SSR"}, {n:"é™³å‚‘æ†²",p:"CF",r:"SSR"}, {n:"æ—å®‰å¯",p:"RF",r:"SSR"}, {n:"é‚±æ™ºå‘ˆ",p:"LF",r:"SR"}, {n:"é™³é‡ç¾½",p:"C",r:"R"}, {n:"æ—ç›Šå…¨",p:"1B",r:"R"}, {n:"æ½˜å‚‘æ¥·",p:"3B",r:"R"}, {n:"é™³è–å¹³",p:"SS",r:"R"}, {n:"é™³é‡å»·",p:"2B",r:"N"}
    ]},
    "dragons": { name: "å‘³å…¨é¾", logo: "ğŸ²", cheers:["æ—è¥„","æå¤šæ…§","å°æ˜ "], roster: [
        {n:"å¾è‹¥ç†™",p:"P",r:"SSR"}, {n:"é‹¼é¾",p:"P",r:"SR"}, {n:"å‰åŠ›å‰æ’ˆ",p:"C",r:"SSR"}, {n:"æå‡±å¨",p:"2B",r:"SR"}, {n:"éƒ­å¤©ä¿¡",p:"CF",r:"SR"}, {n:"åŠ‰åŸºé´»",p:"3B",r:"SR"}, {n:"æ‹¿è«ä¼Šæ¼¾",p:"1B",r:"R"}, {n:"å¼µæ”¿ç¦¹",p:"SS",r:"R"}, {n:"æ—å­ç¨‹",p:"LF",r:"R"}, {n:"å¼µç¥éŠ˜",p:"RF",r:"N"}
    ]},
    "guardians": { name: "å¯Œé‚¦æ‚å°‡", logo: "ğŸ›¡ï¸", cheers:["æ…ˆå¦¹","ä¸¹ä¸¹","ç§€ç§€å­"], roster: [
        {n:"ç¾…æˆˆ",p:"P",r:"SSR"}, {n:"å¯Œè—æˆˆ",p:"P",r:"SR"}, {n:"å¼µè‚²æˆ",p:"SS",r:"SSR"}, {n:"æˆ´åŸ¹å³°",p:"C",r:"SR"}, {n:"èŒƒåœ‹å®¸",p:"1B",r:"R"}, {n:"ç‹æ­£æ£ ",p:"2B",r:"SR"}, {n:"ç”³çš“ç‘‹",p:"CF",r:"R"}, {n:"æå®—è³¢",p:"3B",r:"R"}, {n:"å­”å¿µæ©",p:"RF",r:"N"}, {n:"é™³çœŸ",p:"LF",r:"N"}
    ]},
    "monkeys": { name: "æ¨‚å¤©æ¡ƒçŒ¿", logo: "ğŸ¦", cheers:["ç±ƒç±ƒ","ç³å¦²","Yuri"], roster: [
        {n:"å¨èƒ½å¸",p:"P",r:"SSR"}, {n:"é»ƒå­éµ¬",p:"P",r:"SR"}, {n:"æ—ç«‹",p:"2B",r:"SSR"}, {n:"æœ±è‚²è³¢",p:"1B",r:"SR"}, {n:"é™³æ™¨å¨",p:"CF",r:"SR"}, {n:"æ¢å®¶æ¦®",p:"3B",r:"SR"}, {n:"å»–å¥å¯Œ",p:"DH",r:"SR"}, {n:"é¦¬å‚‘æ£®",p:"SS",r:"R"}, {n:"å®‹å˜‰ç¿”",p:"C",r:"R"}, {n:"æˆæ™‰",p:"RF",r:"N"}
    ]},
    "hawks": { name: "å°é‹¼é›„é·¹", logo: "ğŸ¦…", cheers:["å®‰èŠå„‡","ä¸€ç²’","Mingo"], roster: [
        {n:"é­”é·¹",p:"1B",r:"SSR"}, {n:"å³å¿µåº­",p:"3B",r:"SR"}, {n:"ç‹æŸè",p:"DH",r:"SR"}, {n:"å“ˆç‘ªæ˜Ÿ",p:"P",r:"SR"}, {n:"æ±Ÿæ‰¿è«º",p:"P",r:"R"}, {n:"æ›¾å­ç¥",p:"SS",r:"R"}, {n:"é™³æ–‡æ°",p:"CF",r:"R"}, {n:"å¼µè‚‡å…ƒ",p:"C",r:"R"}, {n:"æœå®¶æ˜",p:"2B",r:"N"}, {n:"è—å¯…å€«",p:"LF",r:"N"}
    ]}
};

const HISTORY = [
    {n:"ç‹å»ºæ°‘",p:"P",r:"SSR"}, {n:"å½­æ”¿é–”",p:"1B",r:"SSR"}, {n:"é»ƒå¹³æ´‹",p:"P",r:"SSR"}, 
    {n:"å¼µæ³°å±±",p:"3B",r:"SR"}, {n:"æ—æ™ºå‹",p:"SS",r:"SR"}
];

// æ–°å¢æ—…å¤–æ€ªç‰©éšŠä¼
const OVERSEAS_ALLSTARS = {
    name: "ğŸ‡¹ğŸ‡¼ æ—…å¤–æ€ªç‰©éšŠ", logo: "â­", 
    roster: [
        {n:"é™³é‡‘é‹’",p:"DH",r:"SSR"}, {n:"éƒ­æ³“å¿—",p:"P",r:"SSR"}, {n:"ç‹æŸè",p:"LF",r:"SSR"}, 
        {n:"å¼µè‚²æˆ",p:"SS",r:"SSR"}, {n:"é™³å‰æ®·",p:"P",r:"SSR"}, {n:"æ—å­å‰",p:"CF",r:"SSR"},
    ]
};


// ================= 2. ç³»çµ±ç‹€æ…‹ =================
let money = 1000000; 
let myRoster = []; 
let lineup = new Array(9).fill(null);
let rotation = { SP:null, RP1:null, RP2:null, CP:null };
let activeCheers = [null, null, null]; 

let game = { active:false, inning:1, top:true, outs:0, bases:[0,0,0], score:{a:0,h:0}, batIdx:{a:0,h:0}, counts:{s:0, b:0} };
let opponent = { name:"", lineup:[], pitcher:null };
let currentPitcher = null; // è¿½è¹¤æˆ‘æ–¹å ´ä¸ŠæŠ•æ‰‹
let gameWeather = null; // ç•¶å‰å¤©æ°£/å ´åœ°å› ç´ 

// éš¨æ©Ÿç”¢ç”Ÿæ…£ç”¨æ‰‹ (R: å³, L: å·¦)
function getRandomHand() {
    return Math.random() < 0.8 ? 'R' : 'L'; // å‡è¨­å³æ’‡å­ä½”å¤šæ•¸
}

function genStats(r) {
    let base = r==="SSR"?92 : r==="SR"?82 : r==="R"?72 : 62;
    let rand = ()=>Math.floor(Math.random()*10);
    let s = { con:base+rand(), pwr:base+rand(), spd:base+rand(), def:base+rand(), stu:base+rand(), total:0 };
    s.total = Math.floor((s.con+s.pwr+s.spd+s.def)/4);
    return s;
}

function createUnit(data, type='player') {
    let u = {
        id: Math.random().toString(36).substr(2,9), name: data.n, type: type, rarity: data.r || "N", 
        pos: data.p || "Cheer", stamina: 100, injury: 0,
        level: data.level || 0,
        hand: getRandomHand() // æ–°å¢æ…£ç”¨æ‰‹
    };
    if(type==='player') {
        u.stats = data.stats ? {...data.stats} : genStats(u.rarity);
        if (u.level > 0) {
            u.stats.con += u.level; u.stats.pwr += u.level; u.stats.spd += u.level;
            u.stats.def += u.level; u.stats.stu += u.level;
            u.stats.total = Math.floor((u.stats.con+u.stats.pwr+u.stats.spd+u.stats.def)/4);
        }
    }
    else u.buff = data.buff || "å£«æ°£";
    return u;
}

// ================= 3. åˆå§‹åŒ–èˆ‡ UI æ¸²æŸ“ =================

function init() {
    const grid = document.getElementById('team-list');
    for(let k in TEAMS) {
        let t = TEAMS[k];
        grid.innerHTML += `
            <div class="team-card" onclick="selectTeam('${k}')">
                <div class="team-logo">${t.logo}</div>
                <h3>${t.name}</h3>
            </div>`;
    }
}

function selectTeam(key) {
    let t = TEAMS[key];
    
    myRoster = [];
    lineup = new Array(9).fill(null);
    rotation = { SP:null, RP1:null, RP2:null, CP:null };

    // åˆå§‹æ ¸å¿ƒçƒå“¡
    t.roster.forEach(p => myRoster.push(createUnit(p)));
    
    // å¢åŠ æ¿å‡³çƒå“¡ (ç¢ºä¿æœ‰è¶³å¤ æŠ•æ‰‹)
    for(let i=0; i<12; i++) {
        let pos;
        if (i < 4) pos = 'P'; 
        else if (i < 8) pos = 'IF';
        else pos = 'OF'; 
        myRoster.push(createUnit({n:`äºŒè»${i}`,p:pos,r:'N'}));
    }
    
    // åˆå§‹å•¦å•¦éšŠ
    t.cheers.forEach(cName => {
        let cData = CHEER_DB.find(x => x.n === cName) || {n:cName, r:"R", buff:"å£«æ°£"};
        myRoster.push(createUnit(cData, 'cheer'));
    });
    
    // åˆå§‹SSRå¤§ç¦®åŒ…
    let gift = HISTORY[Math.floor(Math.random()*HISTORY.length)];
    myRoster.push(createUnit(gift));

    // è‡ªå‹•å¡«å……æ‰“ç·šå’ŒæŠ•æ‰‹è¼ªå€¼
    autoLineup();

    document.getElementById('screen-select').classList.remove('active');
    document.getElementById('screen-main').classList.add('active');
    renderUI();
}

function renderUI() {
    renderLineupTable();
    renderRotationTable();
    renderCheerSlots();
    renderCheerList(); 
    renderRosterList();
    renderFusionCenter(); 
    document.getElementById('money-val').innerText = `$${money.toLocaleString()}`;
}

// Helper: ç²å–æ‰€æœ‰åœ¨é™£å®¹æˆ–è¼ªå€¼ä¸­çš„çƒå“¡/å•¦å•¦éšŠåç¨±
function getUsedNames() {
    const usedNames = new Set();
    lineup.filter(p => p).forEach(p => usedNames.add(p.name));
    Object.values(rotation).filter(p => p).forEach(p => usedNames.add(p.name));
    activeCheers.filter(c => c).forEach(c => usedNames.add(c.name));
    return usedNames;
}

// æ¸²æŸ“æ‰“ç·šè¡¨æ ¼ (æª¢æŸ¥åç¨±é‡è¤‡)
function renderLineupTable() {
    const tb = document.querySelector('#lineup-table tbody');
    tb.innerHTML = "";
    
    for(let i=0; i<9; i++) {
        let curr = lineup[i];
        let usedNames = getUsedNames(); // ç²å–æ‰€æœ‰å·²ç”¨åç¨±
        let opts = `<option value="-1">-- ç©ºç¼º --</option>`;
        let list = myRoster.filter(p => p.type==='player' && p.pos!=='P');
        
        list.forEach(p => {
            let isUsedElsewhere = usedNames.has(p.name) && (!curr || curr.name!==p.name);
            
            if(isUsedElsewhere) return; 
            
            let disabled = p.injury > 0 ? 'disabled' : '';
            let injTxt = p.injury > 0 ? ` (å‚·${p.injury}å ´)` : '';
            let pos_zh = POS_ZH[p.pos] || p.pos;
            let levelTxt = p.level > 0 ? `+${p.level}` : '';
            let sel = (curr&&curr.id===p.id)?'selected':'';
            
            opts += `<option value="${p.id}" ${sel} ${disabled}>
                ${p.name} ${levelTxt} (${pos_zh} / ${HAND_ZH[p.hand]}) - è©•:${p.stats.total} é«”:${p.stamina.toFixed(0)}${injTxt}
            </option>`;
        });
        tb.innerHTML += `<tr><td>${i+1}æ£’</td><td><select onchange="setLineup(${i},this.value)">${opts}</select></td></tr>`;
    }
}

// æ¸²æŸ“æŠ•æ‰‹è¼ªå€¼è¡¨æ ¼ (æª¢æŸ¥åç¨±é‡è¤‡)
function renderRotationTable() {
    const tb = document.querySelector('#rotation-table tbody');
    tb.innerHTML = "";

    ['SP','RP1','RP2','CP'].forEach(role => {
        let curr = rotation[role];
        let usedNames = getUsedNames(); // ç²å–æ‰€æœ‰å·²ç”¨åç¨±
        let opts = `<option value="-1">-- ç©ºç¼º --</option>`;
        let list = myRoster.filter(p => p.type==='player' && p.pos==='P');
        
        list.forEach(p => {
            let isUsedElsewhere = usedNames.has(p.name) && (!curr || curr.name!==p.name);

            if(isUsedElsewhere) return;
            
            let disabled = p.injury > 0 ? 'disabled' : '';
            let injTxt = p.injury > 0 ? ` (å‚·${p.injury}å ´)` : '';
            let levelTxt = p.level > 0 ? `+${p.level}` : '';
            let sel = (curr&&curr.id===p.id)?'selected':'';
            
            opts += `<option value="${p.id}" ${sel} ${disabled}>
                ${p.name} ${levelTxt} (${HAND_ZH[p.hand]}) - å¨:${p.stats.stu} é«”:${p.stamina.toFixed(0)}${injTxt}
            </option>`;
        });
        tb.innerHTML += `<tr><td>${role}</td><td><select onchange="setRot('${role}',this.value)">${opts}</select></td></tr>`;
    });
}

// æ¸²æŸ“å•¦å•¦éšŠ (æª¢æŸ¥åç¨±é‡è¤‡)
function renderCheerSlots() {
    const div = document.getElementById('cheer-slots');
    div.innerHTML = "";
    for(let i=0; i<3; i++) {
        let curr = activeCheers[i];
        let usedNames = getUsedNames(); // ç²å–æ‰€æœ‰å·²ç”¨åç¨± (åŒ…å«çƒå“¡/æŠ•æ‰‹)
        let opts = `<option value="-1">-- ç„¡ --</option>`;
        let list = myRoster.filter(u => u.type==='cheer');
        list.forEach(c => {
            let isUsedElsewhere = usedNames.has(c.name) && (!curr || curr.name!==c.name);
            if(isUsedElsewhere) return;
            let sel = (curr&&curr.id===c.id)?'selected':'';
            opts += `<option value="${c.id}" ${sel}>${c.name} [${c.buff}]</option>`;
        });
        div.innerHTML += `<div style="margin-bottom:5px;"><select onchange="setCheer(${i},this.value)">${opts}</select></div>`;
    }
}

// ç”±æ–¼å•¦å•¦éšŠæ¸…å–®å’Œçƒå“¡æ¸…å–®çš„æ¸²æŸ“é‚è¼¯èˆ‡é‡è¤‡æª¢æŸ¥ç„¡é—œï¼Œæ²¿ç”¨èˆŠç‰ˆã€‚
function renderCheerList() { /* ... (Same as before) ... */
    const v = document.getElementById('cheer-roster-view');
    let cheerleaders = myRoster.filter(u => u.type === 'cheer');
    document.getElementById('cheer-count').innerText = cheerleaders.length;
    v.innerHTML = cheerleaders.map(c => 
        `<span class="cheer-item r-${c.rarity}">
         ${c.name} (${c.buff})
         </span>`
    ).join('');
}
function renderRosterList() { /* ... (Same as before) ... */
    const v = document.getElementById('roster-view');
    document.getElementById('roster-count').innerText = myRoster.filter(u=>u.type==='player').length;
    v.innerHTML = myRoster.map(u => {
        if(u.type === 'cheer') return "";
        let injClass = u.injury > 0 ? "injured" : "";
        let staColor = u.stamina > 80 ? "#4caf50" : u.stamina > 40 ? "#ff9800" : "#f44336";
        let pos_zh = POS_ZH[u.pos] || u.pos;
        let levelTxt = u.level > 0 ? `+${u.level}` : '';
        let hand_zh = HAND_ZH[u.hand] || u.hand;

        return `
            <div style="background:#333; padding:5px; border-radius:4px; font-size:0.8rem; width:120px;">
                <div class="${injClass}"><span class="r-${u.rarity}">${u.name} ${levelTxt}</span> <small>(${pos_zh} / ${hand_zh}) ${u.injury>0?'ğŸ¥'+u.injury:''}</small></div>
                <div style="display:flex; align-items:center; gap:5px;">
                    <small>é«”:</small>
                    <div class="sta-bar-bg"><div class="sta-bar-fill" style="width:${u.stamina.toFixed(0)}%; background:${staColor}"></div></div>
                </div>
            </div>
        `;
    }).join('');
}
function getDuplicatePlayers() { /* ... (Same as before) ... */
    const playerRoster = myRoster.filter(u => u.type === 'player');
    const counts = {};
    const originals = {}; 

    playerRoster.forEach(p => {
        const key = p.name; 
        counts[key] = (counts[key] || 0) + 1;
        
        if (!originals[key]) {
            originals[key] = p;
        } else {
            if (p.level > originals[key].level) {
                originals[key] = p;
            } else if (p.level === originals[key].level) {
                if (RARITY_ORDER[p.rarity] > RARITY_ORDER[originals[key].rarity]) {
                    originals[key] = p;
                } else if (p.rarity === originals[key].rarity && p.stats.total > originals[key].stats.total) {
                    originals[key] = p;
                }
            }
        }
    });

    const duplications = [];
    for (const name in counts) {
        if (counts[name] >= 10) { 
            duplications.push({
                name: name,
                count: counts[name],
                baseUnit: originals[name]
            });
        }
    }
    return duplications;
}
function renderFusionCenter() { /* ... (Same as before) ... */
    const center = document.getElementById('fusion-center');
    const duplications = getDuplicatePlayers();

    if (duplications.length === 0) {
        center.innerHTML = '<p style="color:#aaa; font-style:italic;">ç›®å‰æ²’æœ‰è¶³å¤ çš„é‡è¤‡çƒå“¡å¯ä»¥åˆæˆã€‚</p>';
        return;
    }

    center.innerHTML = '';
    duplications.forEach(d => {
        const canFuse = d.count >= 10;
        const fusionCount = Math.floor(d.count / 10);
        const player = d.baseUnit;
        const pos_zh = POS_ZH[player.pos] || player.pos;
        const levelTxt = player.level > 0 ? `+${player.level}` : '';
        const currentStats = player.stats.total;

        center.innerHTML += `
            <div class="fusion-item">
                <div style="font-weight:bold;">
                    <span class="r-${player.rarity}">${player.name}</span> <small>${levelTxt}</small> (${pos_zh})
                </div>
                <div style="font-size:0.9rem;">
                    æ“æœ‰æ•¸é‡: ${d.count} å¼µ | åŸºç¤å¡ç¸½è©•: ${currentStats}
                </div>
                <button class="btn-fuse" 
                        ${canFuse ? '' : 'disabled'}
                        onclick="fusePlayer('${d.name}', ${fusionCount})">
                    åˆæˆ (${fusionCount * 10} å¼µå¡) -> Lv.${player.level + fusionCount}
                </button>
            </div>
        `;
    });
}
function fusePlayer(playerName, fusionCount) { /* ... (Same as before) ... */
    const playerRoster = myRoster.filter(u => u.type === 'player' && u.name === playerName);
    const count = playerRoster.length;
    const requiredCards = fusionCount * 10;
    
    if (count < requiredCards) {
        alert("éŒ¯èª¤ï¼šé‡è¤‡å¡æ•¸é‡ä¸è¶³ï¼");
        return;
    }

    if (!confirm(`ç¢ºå®šæ¶ˆè€— ${requiredCards} å¼µ ${playerName} çš„å¡ç‰‡ï¼Œå°‡å…¶åˆæˆä¸¦æå‡ ${fusionCount} ç´šå—ï¼Ÿ`)) {
        return;
    }

    let baseCard = getDuplicatePlayers().find(d => d.name === playerName).baseUnit;
    
    // ç²å–æ‰€æœ‰æ­£åœ¨é™£å®¹ä¸­ä½¿ç”¨çš„çƒå“¡åç¨±
    const usedNames = getUsedNames(); 
    
    // å¾å¯ç§»é™¤åˆ—è¡¨ä¸­æ’é™¤æ­£åœ¨ä½¿ç”¨çš„å¡ç‰‡ (å¦‚æœå®ƒä¸æ˜¯ baseCard)
    const removableCards = playerRoster.filter(p => p.id !== baseCard.id && !usedNames.has(p.name));
    
    if (removableCards.length < requiredCards) {
        alert("éŒ¯èª¤ï¼šæ‚¨çš„å¡ç‰‡æ•¸é‡è¶³å¤ ï¼Œä½†è¨±å¤šå¡ç‰‡æ­£åœ¨é™£å®¹æˆ–å•¦å•¦éšŠä¸­è¢«ä½¿ç”¨ã€‚è«‹å…ˆå°‡éåŸºç¤å¡ç§»å‡ºé™£å®¹ã€‚");
        return;
    }
    
    const idsToRemove = removableCards.slice(0, requiredCards).map(c => c.id);
    myRoster = myRoster.filter(p => !idsToRemove.includes(p.id));

    // å‡ç´šåŸºç¤å¡ç‰‡
    const oldLevel = baseCard.level;
    baseCard.level += fusionCount;
    baseCard.stats.con += fusionCount;
    baseCard.stats.pwr += fusionCount;
    baseCard.stats.spd += fusionCount;
    baseCard.stats.def += fusionCount;
    baseCard.stats.stu += fusionCount;
    baseCard.stats.total = Math.floor((baseCard.stats.con + baseCard.stats.pwr + baseCard.stats.spd + baseCard.stats.def) / 4);

    alert(`ğŸ‰ åˆæˆæˆåŠŸï¼${playerName} æå‡ ${fusionCount} ç´šï¼Œç›®å‰ç­‰ç´š Lv.${baseCard.level}ï¼(ç¸½è©•æå‡è‡³ ${baseCard.stats.total})`);
    renderUI();
}

function setLineup(i, id) { lineup[i] = id==="-1"?null:myRoster.find(u=>u.id===id); renderUI(); }
function setRot(r, id) { rotation[r] = id==="-1"?null:myRoster.find(u=>u.id===id); renderUI(); }
function setCheer(i, id) { activeCheers[i] = id==="-1"?null:myRoster.find(u=>u.id===id); renderUI(); }

function autoLineup() {
    // æ‰¾å‡ºæ‰€æœ‰æœªå—å‚·ä¸”æœªåœ¨è¼ªå€¼/å•¦å•¦éšŠä¸­çš„çƒå“¡åç¨±
    const usedNames = getUsedNames();
    
    let availablePlayers = myRoster.filter(u => 
        u.type === 'player' && 
        u.pos !== 'P' && 
        u.injury === 0 &&
        !usedNames.has(u.name)
    ).sort((a,b)=>b.stats.total-a.stats.total);
    
    for(let i=0; i<9; i++) lineup[i] = availablePlayers[i] || null;
    
    let availablePitchers = myRoster.filter(p => 
        p.type === 'player' && 
        p.pos === 'P' && 
        p.injury === 0 &&
        !usedNames.has(p.name)
    ).sort((a,b)=>b.stats.total-a.stats.total);

    rotation.SP = availablePitchers[0] || null;
    rotation.RP1 = availablePitchers[1] || null;
    rotation.RP2 = availablePitchers[2] || null;
    rotation.CP = availablePitchers[3] || null;

    // å˜—è©¦å°‡æœªè¢«ä½¿ç”¨çš„å•¦å•¦éšŠæ”¾å…¥æ‡‰æ´åœ˜
    let availableCheers = myRoster.filter(u => u.type === 'cheer' && !getUsedNames().has(u.name));
    for (let i = 0; i < 3; i++) {
        if (!activeCheers[i] && availableCheers.length > 0) {
            activeCheers[i] = availableCheers.shift();
        }
    }

    renderUI();
}


function startGame() {
    if(lineup.includes(null)) { alert("æ‰“ç·šä¸å®Œæ•´"); return; }
    if(!rotation.SP) { alert("ç„¡å…ˆç™¼æŠ•æ‰‹"); return; }
    
    let requiredP = ['RP1','RP2','CP'].filter(r => rotation[r] === null);
    if(requiredP.length > 0) {
        if(!confirm(`ç‰›æ£šç¼ºå°‘ ${requiredP.join('/')}ï¼Œå¯èƒ½æœƒè®“å…ˆç™¼æŠ•æ‰‹éåº¦å‹ç´¯ã€‚ç¢ºå®šé–‹å§‹å—ï¼Ÿ`)) return; 
    }
    
    if(rotation.SP.stamina < 30) { 
        if(!confirm("å…ˆç™¼æŠ•æ‰‹é«”åŠ›æ¥µä½ï¼å¼·è¡Œå‡ºè³½æ¥µå¯èƒ½å—å‚·ï¼Œç¢ºå®šå—ï¼Ÿ")) return; 
    }
    
    // 1. åˆå§‹åŒ–å¤©æ°£èˆ‡å ´åœ°
    initWeatherAndField();

    game.active = true; game.inning=1; game.top=true; game.outs=0; game.bases=[0,0,0]; game.score={a:0,h:0}; game.batIdx={a:0,h:0};
    game.counts = {s:0, b:0};
    
    // 2. ç”Ÿæˆå°æ‰‹ (ä¿è­‰å¼·åº¦æ¯”ç©å®¶é«˜1%)
    genOpponent();
    
    currentPitcher = rotation.SP;
    updateBoard();
    
    let buffs = activeCheers.filter(c=>c).map(c=>c.buff);
    document.getElementById('active-cheer').innerText = buffs.length ? buffs.join('ã€') : "ç„¡";
    document.getElementById('bullpen-display').innerText = ['RP1','RP2','CP'].map(r=> rotation[r] ? `${rotation[r].name} (é«”:${rotation[r].stamina.toFixed(0)})` : "-").join(' / ');

    document.getElementById('btn-start').disabled = true;
    document.getElementById('btn-start').innerText = "è½‰æ’­ä¸­...";
    log(">>> æ¯”è³½é–‹å§‹ <<<", "log-hl");
    
    setTimeout(playPhase, 1000);
}


function initWeatherAndField() {
    // éš¨æ©Ÿé¸æ“‡å ´åœ°
    gameWeather = WEATHER_DB[Math.floor(Math.random() * WEATHER_DB.length)];
    
    let infoHTML = `
        ğŸŸï¸ å ´åœ°: <strong>${gameWeather.name}</strong> 
        | â˜€ï¸ å¤©æ°£: <span class="weather">${gameWeather.weather}</span> 
        | ğŸ’¨ é¢¨å‘: <span class="wind">${gameWeather.wind}</span>
    `;

    // å¤§å·¨è›‹ç‰¹æ®Šè™•ç†
    if (gameWeather.effect === "Dome") {
        const singerName = gameWeather.singers[Math.floor(Math.random() * gameWeather.singers.length)];
        const domeCheer = createUnit({ n: singerName, r: "Special", buff: "æ¼”å”±æœƒ" }, 'cheer');
        
        // è‡¨æ™‚å¢åŠ ä¸€å€‹å•¦å•¦éšŠBuff
        activeCheers[3] = domeCheer; 
        
        infoHTML += `<br>ğŸ‰ <strong>å¤§å·¨è›‹é¡å¤– Buffï¼š</strong> æ­Œæ‰‹ <span class="r-Special">${singerName}</span> æ‡‰æ´ä¸­ï¼`;
        log(`ğŸ‰ å°åŒ—å¤§å·¨è›‹é™å®šï¼æ­Œæ‰‹ <span class="r-Special">${singerName}</span> å¸¶ä¾†é¡å¤–å£«æ°£æ‡‰æ´ï¼`, "log-hl");

    } else if (gameWeather.desc) {
        infoHTML += ` (${gameWeather.desc})`;
    }

    document.getElementById('weather-info').innerHTML = infoHTML;
}


// ================= 4. æ ¸å¿ƒéŠæˆ²é‚è¼¯ (æ¯”è³½ã€é«”åŠ›ã€ç›¸å‰‹) =================

function getAdjustedStatValue(statValue, rarity, handMatchup = 'Neutral', isPitcher=false) {
    const bounds = RARITY_ADJUSTMENTS;
    const { min, max } = bounds[rarity] || { min: 1.0, max: 1.0 };
    
    let multiplier = min + Math.random() * (max - min); 
    
    // 1. å¤©æ°£/é¢¨å‘å½±éŸ¿ (åƒ…å½±éŸ¿æ‰“è€…åŠ›é‡)
    if (!isPitcher && gameWeather.effect !== "Dome") {
        // é¢¨å‘å¹å‘å¤–é‡ (é †é¢¨) å¢åŠ åŠ›é‡
        if (gameWeather.wind === "å¹å‘å¤–é‡") multiplier *= (1 + (gameWeather.bonus / 100));
        // é¢¨å‘å¹å‘å…§é‡ (é€†é¢¨) æ¸›å°‘åŠ›é‡
        if (gameWeather.wind === "å¹å‘å…§é‡") multiplier *= (1 - (Math.abs(gameWeather.bonus) / 100));
    }
    
    // 2. å·¦å³æŠ•/æ‰“ç›¸å‰‹å½±éŸ¿ (å½±éŸ¿æ‰“è€…èƒ½åŠ›)
    if (!isPitcher) {
        if (handMatchup === 'Conflict') { // åŒå´ (R vs R, L vs L) ç›¸å‰‹
            multiplier *= 0.97; // æ‰“è€…èƒ½åŠ›æ¸›å°‘ 3%
        } else if (handMatchup === 'Advantage') { // ç•°å´ (R vs L, L vs R) ç›¸åˆ©
            multiplier *= 1.02; // æ‰“è€…èƒ½åŠ›å¢åŠ  2%
        }
    }
    
    return Math.round(statValue * multiplier);
}

function getHandMatchup(P, B) {
    if (!P || !B) return 'Neutral';
    if (P.hand === B.hand) return 'Conflict'; // åŒå´ç›¸å‰‹
    return 'Advantage'; // ç•°å´ç›¸åˆ©
}


function simulateAtBat() {
    game.counts = {s:0, b:0};
    const P = game.top ? currentPitcher : opponent.pitcher;
    const B = game.top ? opponent.lineup[game.batIdx.a % 9] : lineup[game.batIdx.h % 9];
    
    if (!B) {
        log(`ğŸš¨ è­¦å‘Šï¼æ‰“ç·šä¸­ç¬¬ ${game.top ? game.batIdx.a % 9 + 1 : game.batIdx.h % 9 + 1} æ£’ç©ºç¼ºï¼Œåˆ¤å‡ºå±€ã€‚`, "log-error");
        addOut();
        return; 
    }
    
    const isHomeDef = game.top;
    const myColor = 'my-team-color';
    const oppColor = 'opp-team-color';
    const P_color = isHomeDef ? myColor : oppColor;
    const B_color = isHomeDef ? oppColor : myColor;

    document.getElementById('curr-p').innerHTML = `<span class="${P_color}">${P.name} (${HAND_ZH[P.hand]})</span>`;
    document.getElementById('curr-b').innerHTML = `<span class="${B_color}">${B.name} (${HAND_ZH[B.hand]})</span>`;
    updateBoard();

    let bonus = 0;
    // å•¦å•¦éšŠ Buff
    if(!game.top) { 
        activeCheers.filter(c=>c).forEach(c => { 
            if(c.buff==="æ‰“æ“Š"||c.buff==="å…¨èƒ½"||c.buff==="æ¼”å”±æœƒ") bonus+=8; 
        }); 
    }
    
    // å·¦å³æŠ•/æ‰“åˆ¤æ–·
    const matchup = getHandMatchup(P, B);

    let outcome = null;

    while (!outcome) {
        // --- NEW: ç²å–å‹•æ…‹èª¿æ•´å¾Œçš„èƒ½åŠ›å€¼ ---
        const B_con = getAdjustedStatValue(B.stats.con, B.rarity, matchup, false);
        const P_stu = getAdjustedStatValue(P.stats.stu, P.rarity, matchup, true);
        // ------------------------------------

        const fatiguePenalty = P.stamina < 20 ? (20 - P.stamina) * 0.5 : 0;
        
        // é¡å¤–é«”åŠ›æ¶ˆè€— (æ¾„æ¸…æ¹–å¤©æ°£)
        const staDrainMultiplier = (gameWeather.weather === "ç‚ç†±") ? 1.1 : 1.0;

        let pitchDiff = (B_con + bonus) - P_stu - fatiguePenalty + (Math.random()*40 - 20); 

        if (P.type === 'player' && isHomeDef) {
            P.stamina = Math.max(0, P.stamina - (0.2 * staDrainMultiplier));
            updateStaBar();
        }

        if (pitchDiff > 10) {
            // --- NEW: ç²å–å‹•æ…‹èª¿æ•´å¾Œçš„Powerå€¼ ---
            const B_pwr = getAdjustedStatValue(B.stats.pwr, B.rarity, matchup, false);
            // ------------------------------------
            
            let hitPowerDiff = (B_pwr + bonus) - P.stats.total + (Math.random()*30 - 15) + (gameWeather.bonus || 0); // å¢åŠ å ´åœ°å› ç´ 
            
            if (hitPowerDiff > 20) {
                outcome = 'HR';
                log(`ğŸ”¥ <span class="${B_color}">${B.name}</span> ç‚¸è£‚ï¼å…¨å£˜æ‰“ï¼`, "log-hl");
            } else {
                outcome = 'Hit';
                handleDefense(B, isHomeDef, B_color, hitPowerDiff);
            }
            if (B.type === 'player' && !isHomeDef) B.stamina = Math.max(0, B.stamina - (0.5 * staDrainMultiplier));

        } else if (pitchDiff > -15) {
            // å·®å‹æ“Šçƒ (Foul/Miss/Out)
            if (Math.random() < 0.3 && game.counts.s < 2) {
                game.counts.s++;
                log(`âš¾ <span class="${B_color}">${B.name}</span> æ®æ£’è½ç©ºï¼Œè¨ˆå¥½çƒã€‚`);
            } else if (game.counts.s < 2) {
                game.counts.s++;
                log(`ğŸ©¹ <span class="${B_color}">${B.name}</span> æ“¦æ£’ç•Œå¤–ï¼Œè¨ˆå¥½çƒã€‚`);
                if (B.type === 'player' && !isHomeDef) B.stamina = Math.max(0, B.stamina - (0.1 * staDrainMultiplier));
            } else {
                outcome = 'Out';
                handleDefense(B, isHomeDef, B_color, -20); 
            }
        } else {
            // å£çƒ (Ball)
            game.counts.b++;
            log(`âšª æŠ•æ‰‹æŠ•å‡ºå£çƒã€‚`);
        }
        
        if (game.counts.s >= 3) {
            outcome = 'SO';
            log(`ğŸ’¨ <span class="${B_color}">${B.name}</span> é­åˆ°ä¸‰æŒ¯ï¼`, "log-out");
        } else if (game.counts.b >= 4) {
            outcome = 'BB';
            log(`ğŸš¶ <span class="${B_color}">${B.name}</span> ç²å¾—å››å£ä¿é€ï¼`, "log-out");
        }
        
        if (outcome) {
            if (outcome === 'BB') scoreRun(0);
            else if (outcome === 'HR') scoreRun(4);
            else if (outcome === 'SO' || outcome === 'Out') addOut();

            game.counts = {s:0, b:0};
            updateBoard();
            return;
        }

        updateBoard(); 
    }
}


function playPhase() { /* ... (Same as before) ... */
    if(!game.active) return;
    
    // --- æ‰£å€’æ¢æ¬¾æª¢æŸ¥ (Mercy Rule) ---
    if (game.inning >= 5 && Math.abs(game.score.a - game.score.h) >= 10) {
        log(`âš ï¸ æå‰çµæŸï¼æ¯”æ•¸å·®è·éå¤§ (10åˆ†å·®)ï¼Œå•Ÿå‹•æ‰£å€’æ¢æ¬¾ã€‚`, "log-error");
        endGame();
        return;
    }

    // --- æ­£å¸¸çµæŸæ¢ä»¶ ---
    if(game.inning>9 && game.score.a!==game.score.h) { endGame(); return; }
    if(game.inning>=9 && !game.top && game.score.h>game.score.a) { endGame(); return; }

    if (game.top) {
        checkSubstitution();
    }
    
    simulateAtBat();

    if(game.top) game.batIdx.a++; else game.batIdx.h++;
    if(game.active) setTimeout(playPhase, 2000);
}

function checkSubstitution() { /* ... (Same as before) ... */
    if (!currentPitcher || currentPitcher.stamina >= 20) return false;

    const roles = ['RP1', 'RP2', 'CP'];
    for (const role of roles) {
        let reliever = rotation[role];
        if (reliever && reliever.stamina > 40 && reliever.injury === 0 && reliever.id !== currentPitcher.id) {
            const oldPName = currentPitcher.name;
            currentPitcher = reliever;
            rotation.SP = reliever;
            
            log(`ğŸ”„ æ›æŠ•ï¼ <span class="my-team-color">${oldPName}</span> (é«”åŠ›:${currentPitcher.stamina.toFixed(0)}) é€€å ´ï¼Œç”± <span class="my-team-color">${reliever.name}</span> æ¥æ›¿ã€‚`, "log-hl");
            document.getElementById('bullpen-display').innerText = ['RP1','RP2','CP'].map(r=> rotation[r] ? `${rotation[r].name} (é«”:${rotation[r].stamina.toFixed(0)})` : "-").join(' / ');
            return true;
        }
    }
    
    if (currentPitcher.stamina < 5) {
        log(`ğŸš¨ è­¦å‘Šï¼ç‰›æ£šç„¡äººï¼Œ<span class="my-team-color">${currentPitcher.name}</span> é«”åŠ›è€—ç›¡ï¼Œè¢«è¿«çºŒæŠ•ï¼`, "log-error");
    }
    return false;
}

function handleDefense(batter, isHomeDef, B_color, hitPowerDiff) { /* ... (Same as before) ... */
    const myColor = 'my-team-color';
    const oppColor = 'opp-team-color';
    const D_color = isHomeDef ? myColor : oppColor;
    
    let locs = ["SS","3B","2B","1B","CF","RF","LF"];
    let loc = locs[Math.floor(Math.random()*locs.length)];
    let loc_zh = POS_ZH[loc] || loc;
    
    let type = ["æ»¾åœ°çƒ","å¹³é£›çƒ","é«˜é£›çƒ"][Math.floor(Math.random()*3)];
    let verb = type==="æ»¾åœ°çƒ" ? "æ»¾å‘" : type==="å¹³é£›çƒ" ? "å°„å‘" : "é£›å‘";
    
    let fielder = null;
    let defRoster = isHomeDef ? lineup : opponent.lineup;

    let f = defRoster.find(x => x && (x.pos === loc || x.pos === 'IF' && ['3B','SS','2B','1B'].includes(loc) || x.pos === 'OF' && ['LF','CF','RF'].includes(loc)));
    if (!f) f = defRoster.find(x => x && x.pos === 'SS');
    if (!f) f = defRoster.find(x => x && x.pos === 'C');
    fielder = f;

    let isHit = false;
    let baseHit = 1;
    
    let defenseModifier = (hitPowerDiff > 10) ? 1.5 : 1; 

    let defenseValue = (fielder && fielder.type === 'player') ? fielder.stats.def / 100 : 0.6;
    let hitChance = 0.5 + (hitPowerDiff / 50) * defenseModifier;
    
    if (Math.random() < hitChance) {
        isHit = true;
        if (hitPowerDiff > 15) baseHit = 2;
        log(`ğŸ“¢ <span class="${B_color}">${batter.name}</span> å°‡çƒæ“Šå‘ ${loc_zh}ï¼Œå½¢æˆ${baseHit}å£˜å®‰æ‰“ï¼`, "log-hl");
    } else {
        let errorChance = 0;
        if (fielder && fielder.type === 'player') {
            errorChance = (100 - fielder.stats.def) * 0.4;
            errorChance += (100 - fielder.stamina) * 0.2;
            errorChance = Math.max(1, errorChance); 
        } else {
            errorChance = 10; 
        }

        if(Math.random() * 100 < errorChance) {
            log(`[E] <span class="${B_color}">${batter.name}</span> ${verb}${loc_zh}ï¼ <span class="${D_color}">${fielder.name||'é‡æ‰‹'}</span> è™•ç†å¤±èª¤ï¼`, "log-error");
            isHit = true; 
        } else {
            let fielderName = fielder ? fielder.name : "é‡æ‰‹";
            let outVerb = type==="æ»¾åœ°çƒ" ? "åˆºæ®ºå‡ºå±€" : "æ¥æ®ºå‡ºå±€";
            log(`ğŸ”´ <span class="${B_color}">${batter.name}</span> ${verb}${loc_zh}ï¼Œè¢« <span class="${D_color}">${fielderName}</span> ${outVerb}ã€‚`, "log-out");
            addOut();
        }
    }

    if (isHit) {
        scoreRun(baseHit);
    }
}
function scoreRun(n) { /* ... (Same as before) ... */
    let r = 0;
    if(n===4) { r=1+game.bases.reduce((a,b)=>a+b,0); game.bases=[0,0,0]; }
    else {
        let runners = [...game.bases]; 
        game.bases=[0,0,0];
        
        for(let i=2; i>=0; i--) {
            if(runners[i]) {
                if (i + n >= 3) { r++; }
                else { game.bases[i+n] = 1; }
            }
        }
        if (n > 0) game.bases[n-1]=1; 
        if (n === 0) {
            if (runners[0] && runners[1] && runners[2]) r++;
            else if (runners[0] && runners[1]) game.bases[2]=1; 
            else if (runners[0]) game.bases[1]=1; 
            game.bases[0] = 1;
        }
        game.bases = game.bases.map(b => b > 1 ? 1 : b); 
    }
    
    if(r>0) {
        if(game.top) game.score.a+=r; else game.score.h+=r;
        log(`>>> å¾— ${r} åˆ†`, "log-score");
    }
    updateBoard();
}
function addOut() { /* ... (Same as before) ... */
    game.outs++;
    if(game.outs>=3) {
        log("--- æ›å±€ ---");
        game.outs=0; game.bases=[0,0,0];
        if(game.top) game.top=false; else { 
            game.top=true; game.inning++; 
            if (rotation.SP !== currentPitcher) rotation.SP = currentPitcher;
        }
        // æ¸…é™¤å¤§å·¨è›‹è‡¨æ™‚å•¦å•¦éšŠ
        if(gameWeather.effect === "Dome") activeCheers[3] = null;
    }
    updateBoard();
}
function updateStaBar() { /* ... (Same as before) ... */
    if (!currentPitcher) return;
    let p = currentPitcher;
    let bar = document.getElementById('my-pitcher-sta').children[0];
    bar.style.width = p.stamina + "%";
    bar.style.background = p.stamina>50?"#4caf50":"#f44336";
}
function updateBoard() { /* ... (Same as before) ... */
    document.getElementById('score-a').innerText = game.score.a;
    document.getElementById('score-h').innerText = game.score.h;
    document.getElementById('inning-txt').innerText = `${game.inning}${game.top?'ä¸Š':'ä¸‹'}`;
    document.getElementById('cnt-o').innerText = game.outs;
    document.getElementById('cnt-s').innerText = game.counts.s;
    document.getElementById('cnt-b').innerText = game.counts.b;
    
    ['1','2','3'].forEach((k,i)=> {
        const baseElement = document.getElementById(`base-${k}`);
        if (game.bases[i]) {
            baseElement.classList.add('active');
        } else {
            baseElement.classList.remove('active');
        }
    });

    let current_status_html = "--- ä¼‘æ¯ä¸­ ---";
    if (game.active) {
        const P = game.top ? currentPitcher : opponent.pitcher;
        const B = game.top ? opponent.lineup[game.batIdx.a % 9] : lineup[game.batIdx.h % 9];
        
        const P_hand = P ? HAND_ZH[P.hand] : 'N/A';
        const B_hand = B ? HAND_ZH[B.hand] : 'N/A';

        if (game.top) {
            current_status_html = `å®ˆå‚™æŠ•æ‰‹: <span class="my-team-color">${P ? P.name : 'N/A'} (${P_hand})</span> (é«”:${P ? P.stamina.toFixed(0) : 'N/A'}) / å°æ‰‹æ‰“è€…: <span class="opp-team-color">${B.name} (${B_hand})</span>`;
        } else {
            current_status_html = `æˆ‘æ–¹æ‰“è€…: <span class="my-team-color">${B.name} (${B_hand})</span> (é«”:${B.stamina.toFixed(0)}) / å°æ‰‹æŠ•æ‰‹: <span class="opp-team-color">${P.name} (${P_hand})</span>`;
        }
    }
    document.getElementById('my-current-action').innerHTML = current_status_html;
    updateStaBar();
}

function endGame() { /* ... (Same as before) ... */
    game.active = false;
    let win = game.score.h > game.score.a;
    let rwd = win ? 2000 : 500;
    
    // å¦‚æœæ˜¯æ—…å¤–éšŠä¼ï¼Œçå‹µæœƒæ›´é«˜
    if(opponent.name === OVERSEAS_ALLSTARS.name) {
        rwd = win ? 5000 : 1000;
        log(`ğŸ† æ“Šæ•— <span class='log-hl'>${OVERSEAS_ALLSTARS.name}</span>ï¼é¡å¤–çå‹µï¼`, "log-hl");
    }
    
    money += rwd; updateMoney();
    log(`ğŸ æ¯”è³½çµæŸï¼ ${win?'ç²å‹':'è½æ•—'}ï¼Œç²å¾— $${rwd}`, "log-hl");
    
    let healBuff = activeCheers.some(c=>c&&c.buff==="å…¨èƒ½"||c&&c.buff==="é«”åŠ›"||c&&c.buff==="æ¼”å”±æœƒ"); // å¢åŠ æ¼”å”±æœƒBuff
    myRoster.forEach(u => {
        if(u.type === 'cheer') return;
        
        const usedNames = getUsedNames(); 
        const played = usedNames.has(u.name);
        
        if(played) {
            let drain = u.pos==='P' ? 20 : 5;
            // ç‚ç†±å¤©æ°£æ¶ˆè€—å¢åŠ 
            if (gameWeather.weather === "ç‚ç†±") drain *= 1.1; 
            if(healBuff) drain *= 0.7;
            u.stamina = Math.max(0, u.stamina - drain);
            
            // å—å‚·åˆ¤å®š
            if(u.stamina < 30) {
                let risk = (30 - u.stamina) * 0.02; 
                if(healBuff) risk *= 0.5;
                if(Math.random() < risk) {
                    u.injury = Math.floor(Math.random()*3) + 3; 
                    log(`ğŸ¥ <span class="my-team-color">${u.name}</span> å› éå‹å—å‚·ï¼éœ€ä¼‘é¤Š ${u.injury} å ´`, "log-inj");
                    
                    // å—å‚·å¾Œå¾é™£å®¹/è¼ªå€¼ä¸­ç§»é™¤ (æŒ‰åç¨±ç§»é™¤)
                    lineup = lineup.map(p => p && p.name === u.name ? null : p);
                    for(let r in rotation) { if(rotation[r] && rotation[r].name === u.name) rotation[r] = null; }
                }
            }
        } else {
            if(u.injury > 0) {
                u.injury--;
                if(u.injury === 0) {
                    u.stamina = 60; 
                    log(`âœ¨ <span class="my-team-color">${u.name}</span> å‚·ç™’æ­¸éšŠï¼`);
                }
            } else {
                u.stamina = Math.min(100, u.stamina + 15);
            }
        }
    });

    // æ¸…é™¤å¤§å·¨è›‹è‡¨æ™‚å•¦å•¦éšŠ
    if(gameWeather.effect === "Dome") activeCheers[3] = null;

    document.getElementById('btn-start').disabled = false;
    document.getElementById('btn-start').innerText = "ğŸ“¡ ä¸‹ä¸€å ´æ¯”è³½";
    renderUI(); 
}

function log(msg, cls) { /* ... (Same as before) ... */
    let d = document.createElement('div'); d.className=cls; d.innerHTML=msg;
    let b = document.getElementById('play-log'); b.appendChild(d); b.scrollTop=b.scrollHeight;
}
function updateMoney() { document.getElementById('money-val').innerText = `$${money.toLocaleString()}`; }
function setTab(t) { /* ... (Same as before) ... */
    ['roster','game','scout'].forEach(x=>document.getElementById(`tab-${x}`).style.display='none');
    document.getElementById(`tab-${t}`).style.display='block';
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector(`.nav-btn[onclick="setTab('${t}')"]`).classList.add('active');
    
    if (t === 'roster') {
        renderUI();
    }
}

function getPlayerAvgRating() {
    const activePlayers = [...lineup.filter(p => p), ...Object.values(rotation).filter(p => p)];
    if (activePlayers.length === 0) return 70; 

    const total = activePlayers.reduce((sum, p) => sum + p.stats.total, 0);
    return total / activePlayers.length;
}

function adjustBaseStats(targetAvg, baseStats) { /* ... (Same as before) ... */
    const ratingDiff = targetAvg - 70; 
    const adjustment = Math.floor(ratingDiff / 10) * 5; 
    
    const newBase = baseStats + adjustment;
    return Math.max(65, Math.min(105, newBase)); 
}


// æ›´æ–°å°æ‰‹ç”Ÿæˆé‚è¼¯ (ä¿è­‰å¼·åº¦æ¯”ç©å®¶é«˜ 1%)
function genOpponent() {
    // 1. æ±ºå®šå°æ‰‹é¡å‹ï¼š5% æ©Ÿç‡é‡åˆ°æ—…å¤–æ€ªç‰©éšŠ
    let oppData;
    let myAvgRating = getPlayerAvgRating();

    if (Math.random() < 0.05) { 
        oppData = OVERSEAS_ALLSTARS;
        log("ğŸ“¢ é­é‡ <span class='log-hl'>ã€å°ç£æ—…å¤–æ€ªç‰©éšŠã€‘</span>ï¼é€™å°‡æ˜¯ä¸€å ´ç¡¬æˆ°ï¼", "log-hl");
    } else {
        let keys = Object.keys(TEAMS); 
        let teamKey = keys[Math.floor(Math.random()*keys.length)];
        oppData = TEAMS[teamKey];
    }
    
    document.getElementById('opp-name').innerText = oppData.name;
    
    // 2. æ ¹æ“šç©å®¶å¹³å‡è©•åˆ†æ±ºå®šå°æ‰‹çš„åŸºç¤æ•¸å€¼ (è‡³å°‘æ¯”ç©å®¶é«˜ 1%)
    let targetOppRating = myAvgRating * 1.01 + (Math.random() * 2); // è‡³å°‘é«˜ 1% + éš¨æ©Ÿå€¼
    
    let oppBase = Math.floor(Math.max(75, Math.min(100, targetOppRating))); // å°æ‰‹æœ€ä½è©•åˆ† 75
    
    // æ—…å¤–éšŠä¼çš„çƒå“¡æ•¸å€¼æ‡‰æ›´é«˜
    if (oppData.name === OVERSEAS_ALLSTARS.name) {
        oppBase = Math.max(90, oppBase); 
    }

    // 3. éš¨æ©Ÿç”Ÿæˆå°æ‰‹æ‰“ç·š
    opponent.lineup = [];
    const usedNames = new Set();
    const posPriorities = ["CF","SS","1B","DH","3B","LF","C","RF","2B"];
    
    for (const pos of posPriorities) {
        let nameCounter = 1;
        let playerTemplate = oppData.roster.find(x => x.p === pos);

        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œæˆ–æ‰¾åˆ°çš„çƒå“¡åç¨±å·²ç¶“è¢«ç”¨æ–¼å…¶ä»–ä½ç½® (ç¢ºä¿åç¨±ä¸é‡è¤‡)
        while((!playerTemplate || usedNames.has(playerTemplate.n)) && nameCounter < 20) {
            // å¾æ‰€æœ‰éšŠä¼ä¸­éš¨æ©ŸæŠ½å–è©²ä½ç½®çš„çƒå“¡ä¾†å¡«å……ï¼Œä»¥å¢åŠ è®ŠåŒ–æ€§
            const allPlayers = Object.values(TEAMS).flatMap(t => t.roster).concat(OVERSEAS_ALLSTARS.roster);
            const posCandidates = allPlayers.filter(p => p.p === pos && !usedNames.has(p.n));
            
            if (posCandidates.length > 0) {
                playerTemplate = posCandidates[Math.floor(Math.random() * posCandidates.length)];
            } else {
                // æœ€å¾Œæ‰‹æ®µï¼šå‰µå»ºä¸€å€‹å®Œå…¨éš¨æ©Ÿçš„é¸æ‰‹
                playerTemplate = {n: `${oppData.name} ${pos}æ‰‹ ${nameCounter++}`, p: pos, r: 'R'};
                break;
            }
        }
        
        usedNames.add(playerTemplate.n);

        let player = createUnit(playerTemplate);
        
        // èª¿æ•´æ•¸å€¼
        player.stats = generateDynamicStats(oppBase, player.pos);
        
        opponent.lineup.push(player);
        if (opponent.lineup.length >= 9) break; 
    }
    
    // 4. æ±ºå®šæŠ•æ‰‹ (èˆ‡æ‰“è€…é‚è¼¯é¡ä¼¼)
    let spTemplate = oppData.roster.find(x=>x.p==='P');
    
    if (!spTemplate || usedNames.has(spTemplate.n)) {
        // å¾æ‰€æœ‰æŠ•æ‰‹å¡ä¸­éš¨æ©Ÿé¸ä¸€å€‹æœªä½¿ç”¨çš„
        const allPitchers = Object.values(TEAMS).flatMap(t => t.roster).concat(OVERSEAS_ALLSTARS.roster).filter(p => p.p === 'P' && !usedNames.has(p.n));
        spTemplate = allPitchers.length > 0 ? allPitchers[Math.floor(Math.random() * allPitchers.length)] : {n:"ç‹ç‰ŒæŠ•æ‰‹",r:"SR",p:'P'};
    }

    opponent.pitcher = createUnit(spTemplate);
    opponent.pitcher.stats = generateDynamicStats(oppBase, opponent.pitcher.pos);
    
    document.getElementById('opp-sp').innerText = `${opponent.pitcher.name} (${HAND_ZH[opponent.pitcher.hand]} / è©•:${opponent.pitcher.stats.total})`;
    document.getElementById('opp-lineup-list').innerHTML = opponent.lineup.map((p,i)=>`<li>${i+1}.${p.name} (${POS_ZH[p.pos]||p.pos} / ${HAND_ZH[p.hand]}) (è©•:${p.stats.total})</li>`).join('');
}


// è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šç›®æ¨™ç¸½è©•ç”Ÿæˆæ•¸å€¼
function generateDynamicStats(targetAvg, pos) { /* ... (Same as before) ... */
    const rand = () => Math.floor(Math.random() * 8) - 4; 
    
    let stats = { con: 0, pwr: 0, spd: 0, def: 0, stu: 0, total: 0 };
    let baseValue = adjustBaseStats(targetAvg, 70); 

    if (pos === 'P') {
        stats.stu = baseValue + rand() + 5; 
        stats.con = baseValue + rand() - 5;
        stats.pwr = baseValue + rand() - 5;
        stats.spd = baseValue + rand();
        stats.def = baseValue + rand();
    } else if (['SS', 'CF'].includes(pos)) {
        stats.def = baseValue + rand() + 5; 
        stats.spd = baseValue + rand() + 5;
        stats.con = baseValue + rand();
        stats.pwr = baseValue + rand() - 5;
        stats.stu = baseValue + rand() - 5;
    } else { 
        stats.con = baseValue + rand() + 5;
        stats.pwr = baseValue + rand();
        stats.def = baseValue + rand();
        stats.spd = baseValue + rand();
        stats.stu = baseValue + rand() - 5;
    }

    for(let key in stats) {
        if (key !== 'total') {
            stats[key] = Math.max(60, Math.min(105, stats[key]));
        }
    }
    
    stats.total = Math.floor((stats.con + stats.pwr + stats.spd + stats.def) / 4);

    return stats;
}

// ================= 5. æ‹›å‹Ÿç³»çµ±æ›´æ–° (å–®æŠ½/åé€£æŠ½) - æ²¿ç”¨èˆŠç‰ˆ =================
function drawSingle() { /* ... (Same as before) ... */
    let rnd = Math.random()*100;
    let data;
    let type = 'player';
    let r = "N";

    if(rnd < 20) {
        let c = CHEER_DB[Math.floor(Math.random()*CHEER_DB.length)]; 
        data = c; 
        type = 'cheer';
        r = c.r;
    } else {
        if(rnd < 25) r = "SSR"; else if(rnd < 40) r = "SR"; else if(rnd < 60) r = "R";
        
        let pool = []; 
        const highRarityPool = [...HISTORY, ...OVERSEAS_ALLSTARS.roster];
        
        if(r==="SSR" || r==="SR") {
             pool = highRarityPool.filter(x=>x.r===r);
             if(pool.length === 0) pool = TEAMS.brothers.roster.filter(x=>x.r===r);
        }
        if(pool.length===0) pool = TEAMS.brothers.roster.filter(x=>x.r==='R');
        if(pool.length===0) pool = [{n:"æ½›åŠ›æ–°ç§€",p:'P',r:'N'}, {n:"æ½›åŠ›æ–°ç§€",p:'IF',r:'N'}]; 

        data = pool[Math.floor(Math.random()*pool.length)];
        data = {...data, y: 1990 + Math.floor(Math.random()*35)};
    }
    
    const unit = createUnit(data, type);
    unit.rarity = r; 
    
    if (unit.type === 'player') {
        unit.stats = genStats(r);
    }

    return unit;
}
function gacha() { /* ... (Same as before) ... */
    if(money < 1000) { alert("è³‡é‡‘ä¸è¶³ï¼å–®æŠ½éœ€è¦ $1,000"); return; }
    money -= 1000; updateMoney();

    const unit = drawSingle();
    myRoster.push(unit);
    renderUI();

    renderGachaResult([unit]);
}
function gachaTen() { /* ... (Same as before) ... */
    if(money < 10000) { alert("è³‡é‡‘ä¸è¶³ï¼åé€£æŠ½éœ€è¦ $10,000"); return; }
    money -= 10000; updateMoney();

    const results = [];
    let hasSSR = false;
    let lowestRarityIndex = -1;
    let lowestRarityValue = 99; 

    for (let i = 0; i < 10; i++) {
        let unit = drawSingle();
        results.push(unit);
        myRoster.push(unit);
        
        if (unit.rarity === 'SSR') {
            hasSSR = true;
        }

        const rarityValue = RARITY_ORDER[unit.rarity] || 0;
        if (unit.type === 'player' && rarityValue < lowestRarityValue) {
            lowestRarityValue = rarityValue;
            lowestRarityIndex = i;
        }
    }

    if (!hasSSR && lowestRarityIndex !== -1) {
        let fallbackUnit = results[lowestRarityIndex];
        
        if (fallbackUnit.type === 'player') {
            fallbackUnit.rarity = 'SSR';
            fallbackUnit.stats = genStats('SSR'); 
            fallbackUnit.stats.total = Math.floor((fallbackUnit.stats.con+fallbackUnit.stats.pwr+fallbackUnit.stats.spd+fallbackUnit.stats.def)/4);
        }
    }

    renderUI();
    renderGachaResult(results);
}
function renderGachaResult(results) { /* ... (Same as before) ... */
    const box = document.getElementById('gacha-result');
    box.innerHTML = results.map(unit => {
        const cls = unit.type === 'cheer' ? "Cheer" : unit.rarity;
        const levelTxt = unit.level > 0 ? `+${unit.level}` : '';
        const nameDisplay = unit.name.length > 4 ? unit.name.substring(0, 4) + '..' : unit.name;
        
        return `
            <div class="gacha-card ${cls}">
                <div style="font-weight:bold;">${unit.rarity}</div>
                <div style="margin:2px 0; font-weight: bold; overflow: hidden; white-space: nowrap;">${nameDisplay} ${levelTxt}</div>
                <div style="font-size:0.7rem;">${unit.type === 'cheer' ? 'å•¦å•¦éšŠ' : POS_ZH[unit.pos] || unit.pos}</div>
            </div>
        `;
    }).join('');
}


init();
</script>
</body>
</html>
